<!-- src/app/features/visualization/visualization.component.html -->

<div class="visualization-container" [class.sidebar-collapsed]="sidebarCollapsed">
  
  <!-- Header avec contr√¥les principaux -->
  <header class="visualization-header">
    <div class="header-left">
      <button class="btn btn-icon" (click)="goBackToSimulation()" title="Retour √† la simulation">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </button>
      <div class="simulation-info">
        <h1>{{ getSimulationTitle() }}</h1>
        <div class="simulation-meta" *ngIf="scene">
          <span>{{ getTotalContainers() }} conteneur(s)</span>
          <span *ngIf="hasMultipleContainers()"> ‚Ä¢ {{ getCurrentContainerName() }}</span>
        </div>
      </div>
    </div>
    
    <div class="header-center" *ngIf="hasMultipleContainers()">
      <div class="container-navigation">
        <button class="btn btn-icon" (click)="previousContainer()" title="Conteneur pr√©c√©dent">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15,18 9,12 15,6"/>
          </svg>
        </button>
        <span class="container-indicator">
          {{ (scene?.currentContainerIndex || 0) + 1 }} / {{ getTotalContainers() }}
        </span>
        <button class="btn btn-icon" (click)="nextContainer()" title="Conteneur suivant">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,18 15,12 9,6"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="header-right" [attr.data-current-view]="currentView">
      <button class="btn btn-toggle" 
              [class.active]="currentView === '3d'"
              [attr.data-toggle-view]="currentView === '3d' ? '2d' : '3d'"
              (click)="toggleView()"
              title="Basculer vue 2D/3D">
        <span *ngIf="currentView === '3d'">3D</span>
        <span *ngIf="currentView === '2d'">2D</span>
      </button>
      
      <button class="btn btn-icon" (click)="resetView()" title="R√©initialiser la vue">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 4v6h6M23 20v-6h-6"/>
          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
        </svg>
      </button>

      <button class="btn btn-icon" (click)="forceRefresh()" title="Actualiser les donn√©es">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6"/>
          <path d="M1 20v-6h6"/>
          <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
      </button>
      
<div class="export-dropdown" *ngIf="!loading && !error && scene">
  <button class="btn btn-icon export-btn" 
          [class.dropdown-open]="showExportMenu"
          (click)="toggleExportMenu()"
          title="Options d'export">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7,10 12,15 17,10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="dropdown-arrow">
      <polyline points="6,9 12,15 18,9"/>
    </svg>
  </button>
  
  <div class="export-menu" *ngIf="showExportMenu">
    <div class="export-section">
      <div class="export-section-title">Exports disponibles</div>
      
      <button class="export-option" (click)="exportCurrentViewAsPNG(); hideExportMenu()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21,15 16,10 5,21"/>
        </svg>
        Vue actuelle ({{ currentView.toUpperCase() }})
      </button>
      
      <button class="export-option" (click)="exportAsJSON(); hideExportMenu()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14,2 14,8 20,8"/>
          <path d="M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1"/>
          <path d="M14 12a1 1 0 0 1 1 1v1a1 1 0 0 0 1 1 1 1 0 0 0-1 1v1a1 1 0 0 1-1 1"/>
        </svg>
        Donn√©es JSON
      </button>

      <button class="export-option export-premium" (click)="exportCompletePackage(); hideExportMenu()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
          <path d="m8 18 4-4 4 4" stroke="#FF6B35" stroke-width="3" fill="none"/>
        </svg>
        <span class="logidoo-text">üìä Rapport Complet avec Calculs</span>
      </button>
    </div>
  </div>
</div>
      
      <button class="btn btn-icon" 
              (click)="toggleSidebar()" 
              title="Basculer panneau lat√©ral">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <line x1="15" y1="3" x2="15" y2="21"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- √âtat de chargement -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>{{ loadingMessage }}</p>
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="loadingProgress"></div>
        </div>
        <span class="progress-text">{{ loadingProgress }}%</span>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div class="error-container" *ngIf="error && !loading">
    <div class="error-message">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <h3>Erreur de visualisation</h3>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="goBackToSimulation()">
        Retour √† la simulation
      </button>
    </div>
  </div>

  <!-- Interface principale -->
  <div class="main-interface" *ngIf="!loading && !error && scene">
    
    <!-- Barre d'outils -->
    <!-- <div class="toolbar-container">
      <app-toolbar 
        [scene]="scene" 
        [config]="config" 
        [viewport]="viewport">
      </app-toolbar>
    </div> -->
    
    <!-- Zone de visualisation -->
    <div class="visualization-area">
      
      <!-- Contr√¥les de vue 2D -->
      <div class="view-controls-2d" *ngIf="currentView === '2d'">
        <div class="view-selector">
          <span class="view-label">Vue 2D :</span>
          <div class="view-buttons">
            <button class="view-btn" 
                    [class.active]="current2DView === 'top'"
                    (click)="change2DView('top')"
                    title="Vue de dessus (Plan)">
              <span>Plan</span>
            </button>
            <button class="view-btn" 
                    [class.active]="current2DView === 'bottom'"
                    (click)="change2DView('bottom')"
                    title="Vue de dessous">
              <span>Dessous</span>
            </button>
            <button class="view-btn" 
                    [class.active]="current2DView === 'side'"
                    (click)="change2DView('side')"
                    title="Vue de c√¥t√©">
              <span>C√¥t√©</span>
            </button>
            <button class="view-btn" 
                    [class.active]="current2DView === 'side-opposite'"
                    (click)="change2DView('side-opposite')"
                    title="Vue c√¥t√© oppos√©">
              <span>C√¥t√© oppos√©</span>
            </button>
            <button class="view-btn" 
                    [class.active]="current2DView === 'front'"
                    (click)="change2DView('front')"
                    title="Vue de face (Avant)">
              <span>Avant</span>
            </button>
            <button class="view-btn" 
                    [class.active]="current2DView === 'back'"
                    (click)="change2DView('back')"
                    title="Vue arri√®re">
              <span>Arri√®re</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="viewer-container">
        
        <!-- Vue 2D -->
        <app-canvas 
          *ngIf="currentView === '2d' && scene && !loading" 
          [scene]="scene"
          [config]="config"
          [viewport]="viewport">
        </app-canvas>
        

        <!-- Indicateur de chargement pour vue 2D -->
        <div *ngIf="currentView === '2d' && (loading || !scene)" class="loading-2d">
          <div class="loading-spinner"></div>
          <p>Chargement de la vue 2D...</p>
          <small *ngIf="!scene">En attente des donn√©es de simulation</small>
          <small *ngIf="loading">Initialisation en cours...</small>
        </div>
        
        <!-- Vue 3D -->
        <app-scene 
          *ngIf="currentView === '3d'" 
          [scene]="scene"
          [config]="config"
          [viewport]="viewport">
        </app-scene>
        
        <!-- Indicateurs de vue -->
        <div class="view-indicators">
          <!-- <div class="view-mode-badge" [attr.data-mode]="currentView">
            {{ currentView.toUpperCase() }}
          </div>
          
          <div class="zoom-indicator" *ngIf="viewport">
            Zoom: {{ (viewport.zoom * 100) | number:'1.0-0' }}%
          </div> -->
        </div>
      </div>
    </div>
    
    <!-- Panneau lat√©ral -->
    <div class="sidebar" [class.collapsed]="sidebarCollapsed">
      <app-panel 
        [scene]="scene"
        [config]="config">
      </app-panel>
    </div>
  </div>

</div>


<style>
.export-dropdown {
  position: relative;
  display: inline-block;
}

.export-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  min-width: auto;
}

.export-btn .dropdown-arrow {
  transition: transform 0.2s ease;
}

.export-btn.dropdown-open .dropdown-arrow {
  transform: rotate(180deg);
}

.export-menu {
  position: absolute;
  top: 100%;
  right: 0;
  z-index: 1000;
  min-width: 280px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  margin-top: 4px;
}

.export-section {
  padding: 8px 0;
}

.export-section:not(:last-child) {
  border-bottom: 1px solid #f1f5f9;
}

.export-section-title {
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.export-option {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border: none;
  background: none;
  text-align: left;
  color: #334155;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s ease;
  position: relative;
}

.export-option:hover {
  background-color: #f8fafc;
  color: #0f172a;
}

.export-option:active {
  background-color: #e2e8f0;
}

.export-option svg {
  flex-shrink: 0;
  color: #64748b;
}

.export-option:hover svg {
  color: #3b82f6;
}

.export-premium {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-left: 3px solid #3b82f6;
}

.export-premium:hover {
  background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
}

.premium-badge {
  margin-left: auto;
  font-size: 12px;
}

/* Overlay pour fermer le menu */
.export-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  background: transparent;
}

/* Animation d'ouverture */
.export-menu {
  animation: slideDown 0.2s ease-out;
  transform-origin: top right;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-8px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Responsive */
@media (max-width: 768px) {
  .export-menu {
    right: -8px;
    min-width: 260px;
  }
}
</style>



