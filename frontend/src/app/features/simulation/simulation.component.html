<div class="logidoo-container">
  <!-- Header -->
  <div class="header">
    <button class="back-btn" routerLink="/dashboard/user">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
    </button>
    <div class="logo-container">
      <div class="logo">
        <span class="logo-text">Logid</span>
        <span class="logo-infinity">âˆž</span>
      </div>
    </div>
  </div>

  <!-- Title -->
  <div class="title-section">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
      <polyline points="9,22 9,12 15,12 15,22" />
    </svg>
    <h1>Aide au Chargement</h1>
  </div>

  <!-- Stepper Navigation -->
  <div class="stepper-container">
    <div class="stepper-steps" [ngClass]="'step-' + currentStep">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
        <div class="step-circle">1</div>
        <span class="step-label">Informations Simulation</span>
      </div>
      
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" 
           (click)="currentStep > 1 || canProceedFromStep1() ? goToStep(2) : null"
           [class.disabled]="currentStep === 1 && !canProceedFromStep1()">
        <div class="step-circle">2</div>
        <span class="step-label">Ajout de Colis</span>
      </div>
      
      <div class="step" [class.active]="currentStep === 3" 
           (click)="currentStep > 2 || (canProceedFromStep1() && canProceedFromStep2()) ? goToStep(3) : null"
           [class.disabled]="currentStep < 3 && (!canProceedFromStep1() || !canProceedFromStep2())">
        <div class="step-circle">3</div>
        <span class="step-label">Choix de Contenant</span>
      </div>
    </div>
  </div>

  <!-- Step 1: Informations Simulation -->
  <div class="step-content" *ngIf="currentStep === 1">
    <div class="simulation-info">
      <form [formGroup]="simulationForm" class="simulation-form">
        <div class="form-row">
          <div class="form-group">
            <label>Nom de la simulation *</label>
            <input type="text" formControlName="nom" placeholder="Ex: Livraison Paris - Janvier 2025"
              class="form-control">
          </div>
          <div class="form-group">
            <label>Description (optionnel)</label>
            <input type="text" formControlName="description" placeholder="Description de la simulation"
              class="form-control">
          </div>
        </div>
      </form>
      
      <div class="step-actions">
        <button class="btn-primary" (click)="nextStep()" [disabled]="!canProceedFromStep1()">
          Suivant : Ajouter des colis
        </button>
      </div>
    </div>
  </div>

  <!-- Step 2: Ajout de Colis -->
  <div class="step-content" *ngIf="currentStep === 2">
    <div class="compact-layout">
      <!-- Formulaire d'ajout de colis optimisÃ© -->
      <div class="colis-form-card">
        <div class="form-header">
          <h2>
            <span class="icon">ðŸ“¦</span>
            Ajouter un colis
          </h2>
        </div>

        <form [formGroup]="colisForm" class="compact-form">
          <!-- Ligne 1: Type et QuantitÃ© -->
          <div class="form-row-compact">
            <div class="form-group flex-2">
              <label>Type de colis *</label>
              <input type="text" formControlName="type" placeholder="Ex: Carton, Palette..." class="form-control">
            </div>
            <div class="form-group flex-1">
              <label>QuantitÃ© *</label>
              <input type="number" formControlName="quantite" class="form-control" min="1">
            </div>
          </div>

          <!-- Ligne 2: Dimensions -->
          <div class="dimensions-group">
            <label class="group-label">Dimensions (cm) *</label>
            <div class="form-row-compact">
              <div class="form-group">
                <input type="number" formControlName="longueur" placeholder="L" class="form-control">
                <small>Longueur</small>
              </div>
              <div class="form-group">
                <input type="number" formControlName="largeur" placeholder="l" class="form-control">
                <small>Largeur</small>
              </div>
              <div class="form-group">
                <input type="number" formControlName="hauteur" placeholder="H" class="form-control">
                <small>Hauteur</small>
              </div>
              <div class="form-group">
                <input type="number" step="0.1" formControlName="poids" placeholder="Poids" class="form-control">
                <small>Poids (kg)</small>
              </div>
            </div>
          </div>

          <!-- Ligne 3: Options -->
          <div class="options-group">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="fragile" />
                <span class="checkmark"></span>
                Fragile
              </label>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="gerbable" />
                <span class="checkmark"></span>
                Empilable
              </label>
              <div class="color-picker">
                <label>Couleur</label>
                <input type="color" formControlName="couleur" class="color-input">
              </div>
            </div>
          </div>

          <!-- Section destinataire repliable -->
          <div class="collapsible-section">
            <button type="button" class="toggle-btn" (click)="showDestinataireForm = !showDestinataireForm">
              <span [class.rotated]="showDestinataireForm">â–¶</span>
              Informations destinataire (optionnel)
            </button>
            
            <div class="collapsible-content" [class.expanded]="showDestinataireForm">
              <div class="form-row-compact">
                <div class="form-group">
                  <input type="text" formControlName="nomDestinataire" placeholder="Nom" class="form-control">
                </div>
                <div class="form-group flex-2">
                  <input type="text" formControlName="adresse" placeholder="Adresse" class="form-control">
                </div>
                <div class="form-group">
                  <input type="tel" formControlName="telephone" placeholder="TÃ©lÃ©phone" class="form-control">
                </div>
              </div>
            </div>
          </div>

          <button type="button" (click)="ajouterColis()" class="btn-add-colis" [disabled]="!colisForm.valid">
            <span class="btn-icon">+</span>
            Ajouter le colis
          </button>
        </form>
      </div>

      <!-- Import Excel compact -->
      <div class="import-card">
        <div class="import-header">
          <span class="icon">ï¿½</span>
          <span>Import Excel</span>
        </div>
        <input type="file" #fileInput accept=".xlsx,.xls" (change)="importerDepuisExcel($event)" class="file-input" id="excel-file">
        <label for="excel-file" class="btn-import">
          Choisir un fichier
        </label>
        <button class="btn-template" (click)="telechargerModele()">
          TÃ©lÃ©charger modÃ¨le
        </button>
      </div>
    </div>

    <!-- Liste des colis ajoutÃ©s -->
    <div class="colis-list" *ngIf="listeColis.length > 0">
      <h3>Colis ajoutÃ©s ({{ calculerNombreColisTotal() }})</h3>
      <div class="colis-grid">
        <div *ngFor="let colis of listeColis; let i = index" class="colis-item">
          <div class="colis-header">
            <div class="colis-color" [style.background-color]="colis.couleur"></div>
            <span class="colis-type">{{ colis.type }}</span>
            <span class="colis-quantity">x{{ colis.quantite }}</span>
            <button class="delete-btn" (click)="supprimerColis(i)">Ã—</button>
          </div>
          
          <div class="colis-details">
            <div class="dimension-grid">
              <div class="dimension-item">
                <span class="label">L:</span>
                <span class="value">{{ colis.longueur }}cm</span>
              </div>
              <div class="dimension-item">
                <span class="label">l:</span>
                <span class="value">{{ colis.largeur }}cm</span>
              </div>
              <div class="dimension-item">
                <span class="label">H:</span>
                <span class="value">{{ colis.hauteur }}cm</span>
              </div>
              <div class="dimension-item">
                <span class="label">Poids:</span>
                <span class="value">{{ colis.poids }}kg</span>
              </div>
            </div>
            
            <div class="colis-properties">
              <span *ngIf="colis.fragile" class="property-badge fragile">Fragile</span>
              <span *ngIf="colis.gerbable" class="property-badge gerbable">Empilable</span>
              <span *ngIf="!colis.gerbable" class="property-badge non-gerbable">Non empilable</span>
            </div>
            
            <div class="colis-actions">
              <label class="color-input">
                Couleur:
                <input type="color" [value]="colis.couleur" 
                       (change)="updateColisCouleur(i, $any($event.target).value)">
              </label>
              <label class="checkbox-input">
                <input type="checkbox" [checked]="colis.fragile" (change)="toggleFragile(i)"> Fragile
              </label>
              <label class="checkbox-input">
                <input type="checkbox" [checked]="colis.gerbable" (change)="toggleGerbable(i)"> Empilable
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">PrÃ©cÃ©dent</button>
      <button class="btn-primary" (click)="nextStep()" [disabled]="!canProceedFromStep2()">
        Suivant : Choisir un contenant
      </button>
    </div>
  </div>

  <!-- Step 3: Choix de Contenant -->
  <div class="step-content" *ngIf="currentStep === 3">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">ðŸ§±</div>
        <h2>SÃ©lection du contenant</h2>
        <div class="selection-mode-toggle">
          <label [class.active]="selectionAutoOptimal">
            <input type="checkbox" [checked]="selectionAutoOptimal" (change)="toggleSelectionMode()">
            SÃ©lection automatique
          </label>
        </div>
      </div>

      <!-- Message explicatif pour le mode de sÃ©lection -->
      <div class="selection-mode-explanation">
        <p *ngIf="selectionAutoOptimal">
          Mode <strong>automatique</strong> activÃ© : le conteneur le plus optimal sera sÃ©lectionnÃ© pour vos colis
        </p>
        <p *ngIf="!selectionAutoOptimal">
          Mode <strong>manuel</strong> activÃ© : sÃ©lectionnez le conteneur de votre choix
        </p>
      </div>

      <!-- Affichage du conteneur optimal -->
      <div *ngIf="selectionAutoOptimal && optimalContainer" class="optimal-container-info">
        <div class="optimal-container-card">
          <div class="optimal-badge">
            <span>RecommandÃ©</span>
          </div>

          <div class="container-header">
            <strong>{{ optimalContainer.containerType }}</strong>
            <span class="container-category">{{ optimalContainer.containerCategory }}</span>
          </div>

          <div class="container-stats">
            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(optimalContainer.volumeUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Volume: {{ optimalContainer.volumeUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(optimalContainer.weightUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Poids: {{ optimalContainer.weightUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="placement-info">
              <strong>{{ optimalContainer.placedItems }}</strong> / {{ optimalContainer.totalItems }} colis placÃ©s
            </div>
          </div>

          <div class="container-dimensions">
            <span>{{ optimalContainer.dimensions.longueur }} Ã— {{ optimalContainer.dimensions.largeur }} Ã— {{
              optimalContainer.dimensions.hauteur }} mm</span>
            <span>Volume: {{ optimalContainer.volume }} mÂ³</span>
            <span>CapacitÃ©: {{ optimalContainer.capacitePoids }} kg max</span>
          </div>
        </div>
      </div>

      <!-- Affichage des stats du conteneur sÃ©lectionnÃ© manuellement -->
      <div *ngIf="!selectionAutoOptimal && selectedContainerStats" class="selected-container-info">
        <div class="selected-container-card">
          <div class="container-header">
            <strong>{{ selectedContainerStats.containerType }}</strong>
            <span class="container-category">{{ selectedContainerStats.containerCategory }}</span>
          </div>

          <div class="container-stats">
            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(selectedContainerStats.volumeUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Volume: {{ selectedContainerStats.volumeUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(selectedContainerStats.weightUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Poids: {{ selectedContainerStats.weightUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>
          </div>

          <div class="placement-stats">
            <span class="placement-info">
              <strong>{{ selectedContainerStats.placedItems }}</strong> / {{ selectedContainerStats.totalItems }}
              colis placÃ©s
            </span>
            <span class="score-info" [class.good-score]="selectedContainerStats.optimalityScore > 0.7"
              [class.medium-score]="selectedContainerStats.optimalityScore > 0.4 && selectedContainerStats.optimalityScore <= 0.7"
              [class.low-score]="selectedContainerStats.optimalityScore <= 0.4">
              Score d'optimalitÃ©: {{ selectedContainerStats.optimalityScore | percent:'1.0-0' }}
            </span>
          </div>

          <div class="container-dimensions">
            <span>{{ selectedContainerStats.dimensions.longueur }} Ã— {{ selectedContainerStats.dimensions.largeur }} Ã—
              {{ selectedContainerStats.dimensions.hauteur }} mm</span>
            <span>Volume: {{ selectedContainerStats.volume }} mÂ³</span>
            <span>CapacitÃ©: {{ selectedContainerStats.capacitePoids }} kg max</span>
          </div>
        </div>
      </div>

      <!-- Indicateur de chargement pour l'Ã©valuation du conteneur -->
      <div *ngIf="evaluatingContainer" class="container-loading">
        <div class="loading-spinner"></div>
        <span>Ã‰valuation du conteneur en cours...</span>
      </div>

      <!-- Liste des conteneurs disponibles -->
      <div class="contenants-grid" [class.dimmed]="selectionAutoOptimal && optimalContainer">
        <div *ngFor="let c of containers" class="conteneur-card" [class.selected]="c._id === selectedContainerId"
          [class.optimal]="optimalContainer && c._id === optimalContainer.containerId"
          (click)="selectContainer(c._id)">
          <img *ngIf="c.images && c.images.length > 0" [src]="'https://logidoo.onrender.com' + c.images[0]"
            [alt]="c.type" width="100">
          <div class="conteneur-title">Type: {{ c.type }}</div>
          <div class="conteneur-dimensions">
            {{ c.dimensions.longueur }} Ã— {{ c.dimensions.largeur }} Ã— {{ c.dimensions.hauteur }} mm
          </div>
          <div class="conteneur-volume">Volume: {{ c.volume }} mÂ³</div>
          <div class="conteneur-poids">CapacitÃ©: {{ c.capacitePoids }} kg max</div>
          <span class="conteneur-badge" *ngIf="c.categorie === 'conteneur'">Conteneurs</span>
          <span class="conteneur-badge camion" *ngIf="c.categorie === 'camion'">Camions</span>
          <div *ngIf="optimalContainer && c._id === optimalContainer.containerId" class="optimal-marker">
            <span>Optimal</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RÃ©sumÃ© des colis -->
    <div *ngIf="listeColis.length > 0" class="card colis-summary-card">
      <h3>RÃ©sumÃ© des colis ({{ calculerNombreColisTotal() }})</h3>
      <div class="colis-summary">
        <div class="summary-item">
          <strong>{{ calculerNombreColisTotal() }}</strong>
          <span>Total colis</span>
        </div>
        <div class="summary-item">
          <strong>{{ calculerVolumeTotal() | number:'1.2-2' }} mÂ³</strong>
          <span>Volume total</span>
        </div>
        <div class="summary-item">
          <strong>{{ calculerPoidsTotal() | number:'1.2-2' }} kg</strong>
          <span>Poids total</span>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">PrÃ©cÃ©dent</button>
      <button (click)="lancerSimulation()" class="btn-primary"
        *ngIf="(!simulationResultats && !simulationEnCours) && listeColis.length > 0 && (selectedContainerId || selectionAutoOptimal)"
        [disabled]="findingOptimal">
        {{ findingOptimal
          ? 'Recherche du conteneur optimal...'
          : (selectionAutoOptimal
              ? 'Lancer la simulation (sÃ©lection auto)'
              : 'Lancer la simulation')
        }}
      </button>
    </div>
  </div>

</div>