<div class="logidoo-container">
  <!-- Header -->
  <div class="header">
    <button class="back-btn" routerLink="/dashboard/user">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
    </button>
    <div class="logo-container">
      <div class="logo">
        <span class="logo-text">Logid</span>
        <span class="logo-infinity">‚àû</span>
      </div>
    </div>
  </div>

  <!-- Title -->
  <div class="title-section">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
      <polyline points="9,22 9,12 15,12 15,22" />
    </svg>
    <h1>Aide au Chargement</h1>
  </div>

  <!-- Ste            <div class="feature-item">
              <span class="feature-icon">üìä</span>
              <span>Mesures et statistiques</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button class="btn-primary" (click)="nouvelleSimulation()">
        Nouvelle simulation
      </button>
    </div>
  </div>-->
  <div class="stepper-container">
    <div class="stepper-steps" [ngClass]="'step-' + currentStep">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
        <div class="step-circle">1</div>
        <span class="step-label">Informations Simulation</span>
      </div>
      
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" 
           (click)="currentStep > 1 || canProceedFromStep1() ? goToStep(2) : null"
           [class.disabled]="currentStep === 1 && !canProceedFromStep1()">
        <div class="step-circle">2</div>
        <span class="step-label">Ajout de Colis</span>
      </div>
      
      <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3"
           (click)="currentStep > 2 || (canProceedFromStep1() && canProceedFromStep2()) ? goToStep(3) : null"
           [class.disabled]="currentStep < 3 && (!canProceedFromStep1() || !canProceedFromStep2())">
        <div class="step-circle">3</div>
        <span class="step-label">Choix de Contenant</span>
      </div>

      <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4"
           (click)="currentStep > 3 || canProceedFromStep3() ? goToStep(4) : null"
           [class.disabled]="currentStep < 4 && !canProceedFromStep3()">
        <div class="step-circle">4</div>
        <span class="step-label">Calcul & Simulation</span>
      </div>

      <div class="step" [class.active]="currentStep === 5" [class.completed]="currentStep > 5"
           (click)="currentStep > 4 || simulationResultats ? goToStep(5) : null"
           [class.disabled]="!simulationResultats">
        <div class="step-circle">5</div>
        <span class="step-label">Visualisation</span>
      </div>
    </div>
  </div>

  <!-- Step 1: Informations Simulation -->
  <div class="step-content" *ngIf="currentStep === 1">
    <div class="simulation-info">
      <form [formGroup]="simulationForm" class="simulation-form">
        <div class="form-row">
          <div class="form-group">
            <label>Nom de la simulation *</label>
            <input type="text" formControlName="nom" placeholder="Ex: Livraison Paris - Janvier 2025"
              class="form-control">
          </div>
          <div class="form-group">
            <label>Description (optionnel)</label>
            <input type="text" formControlName="description" placeholder="Description de la simulation"
              class="form-control">
          </div>
        </div>
      </form>
      
      <div class="step-actions">
        <button class="btn-primary" (click)="nextStep()" [disabled]="!canProceedFromStep1()">
          Suivant : Ajouter des colis
        </button>
      </div>
    </div>
  </div>

  <!-- Step 2: Ajout de Colis -->
  <div class="step-content" *ngIf="currentStep === 2">
    <!-- Layout en grid : Ajout manuel et Import Excel c√¥te √† c√¥te -->
    <div class="dual-input-grid" *ngIf="showInputForms">
      <!-- Section Ajout Manuel -->
      <div class="manual-section">
        <div class="colis-form-card-compact">
          <div class="form-header-compact">
            <h3><span class="icon">üì¶</span> Ajout manuel</h3>
            <p class="subtitle">Saisissez les informations de votre colis</p>
          </div>

          <form [formGroup]="colisForm" class="ultra-compact-form">
            <!-- Ligne 1: Type, Quantit√©, Fragile, Empilable, Couleur -->
            <div class="form-row-primary">
              <div class="form-group-mini">
                <label>Type</label>
                <input type="text" formControlName="type" placeholder="Carton, Palette..." class="form-control-mini">
              </div>
              <div class="form-group-mini quantity">
                <label>Qt√©</label>
                <input type="number" formControlName="quantite" class="form-control-mini" min="1" value="1">
              </div>
              <label class="checkbox-mini">
                <input type="checkbox" formControlName="fragile" />
                <span class="check-text">Fragile</span>
              </label>
              <label class="checkbox-mini">
                <input type="checkbox" formControlName="gerbable" />
                <span class="check-text">Empilable</span>
              </label>
              <div class="color-mini">
                <label>Couleur</label>
                <input type="color" formControlName="couleur" class="color-input-mini">
              </div>
            </div>

            <!-- Ligne 2: Dimensions -->
            <div class="form-row-secondary">
              <label class="dimensions-label">Dimensions (cm) & Poids (kg)</label>
              <div class="dimensions-inputs">
                <input type="number" formControlName="longueur" placeholder="Longueur" class="dimension-input">
                <span class="separator">√ó</span>
                <input type="number" formControlName="largeur" placeholder="Largeur" class="dimension-input">
                <span class="separator">√ó</span>
                <input type="number" formControlName="hauteur" placeholder="Hauteur" class="dimension-input">
                <span class="separator">|</span>
                <input type="number" step="0.1" formControlName="poids" placeholder="Poids" class="dimension-input weight">
              </div>
            </div>

            <!-- Bouton d'ajout -->
            <button type="button" (click)="ajouterColis()" class="btn-add-compact" [disabled]="!colisForm.valid">
              <span class="plus-icon">+</span>
              Ajouter
            </button>
          </form>

          <!-- Section destinataire repliable (plus discr√®te) -->
          <div class="collapsible-mini" *ngIf="!showDestinataireForm">
            <button type="button" class="toggle-mini" (click)="showDestinataireForm = true">
              + Infos destinataire (optionnel)
            </button>
          </div>
          
          <div class="destinataire-section" *ngIf="showDestinataireForm">
            <div class="destinataire-header">
              <span>Informations destinataire</span>
              <button type="button" class="close-mini" (click)="showDestinataireForm = false">√ó</button>
            </div>
            <div class="destinataire-form">
              <input type="text" formControlName="nomDestinataire" placeholder="Nom" class="form-control-mini">
              <input type="text" formControlName="adresse" placeholder="Adresse compl√®te" class="form-control-mini">
              <input type="tel" formControlName="telephone" placeholder="T√©l√©phone" class="form-control-mini">
            </div>
          </div>
        </div>
      </div>

      <!-- Section Import Excel -->
      <div class="excel-section">
        <div class="import-card-enhanced">
          <div class="form-header-compact">
            <h3><span class="icon">üìä</span> Import Excel</h3>
            <p class="subtitle">Importez plusieurs colis en une fois</p>
          </div>
          
          <div class="import-zone">
            <input type="file" #fileInput accept=".xlsx,.xls" (change)="importerDepuisExcel($event)" class="file-input" id="excel-file">
            
            <div class="drop-area">
              <div class="excel-icon">üìÑ</div>
              <p class="drop-text">Glissez votre fichier Excel ici<br>ou cliquez pour choisir</p>
            </div>
            
            <div class="import-actions">
              <label for="excel-file" class="btn-uniform btn-primary">
                <span class="btn-icon">üìÅ</span>
                Choisir un fichier
              </label>
              <button class="btn-uniform btn-secondary" (click)="telechargerModele()">
                <span class="btn-icon">‚¨áÔ∏è</span>
                T√©l√©charger mod√®le
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions apr√®s ajout de colis (manuel ou import) -->
    <div class="post-add-actions" *ngIf="listeColis.length > 0">
      <div class="main-action">
        <button class="btn-contenant-primary" (click)="nextStep()" [disabled]="!canProceedFromStep2()">
          <span class="btn-icon">üß±</span>
          Choix de contenant
        </button>
      </div>
      
      <div class="secondary-actions">
        <button class="btn-secondary-action" (click)="viderTousLesColis()">
          <span class="btn-icon">üóëÔ∏è</span>
          Vider tout
        </button>
        <button class="btn-secondary-action" (click)="ajouterAutresColis()">
          <span class="btn-icon">‚ûï</span>
          Ajouter un autre colis
        </button>
      </div>
    </div>

    <!-- Liste moderne des colis ajout√©s -->
    <div class="modern-colis-container" *ngIf="listeColis.length > 0">
      <div class="modern-colis-header">
        <h3>
          <span class="package-icon">üì¶</span>
          Colis ajout√©s
          <span class="count-badge">{{ listeColis.length }}</span>
        </h3>
        
        <div class="view-controls">
          <div class="view-toggle">
            <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'">
              ‚äû Grille
            </button>
            <button class="view-btn" [class.active]="viewMode === 'list'" (click)="viewMode = 'list'">
              ‚ò∞ Liste
            </button>
          </div>
          
          <div class="items-per-page" *ngIf="listeColis.length > 6">
            <select [(ngModel)]="colisPerPage" (change)="onPageSizeChange()">
              <option value="6">6 par page</option>
              <option value="12">12 par page</option>
              <option value="24">24 par page</option>
              <option value="50">Tout afficher</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="modern-colis-grid" [class.list-view]="viewMode === 'list'">
        <div *ngFor="let colis of getPaginatedColis(); let i = index" 
             class="modern-colis-card"
             [style.--colis-color]="colis.couleur">
          
          <div class="color-indicator"></div>
          
          <div class="card-header">
            <div class="card-top-row">
              <div class="card-number">{{ getCurrentPageIndex() * colisPerPage + i + 1 }}</div>
              
              <div class="card-actions">
                <div class="color-picker-btn" [style.background]="colis.couleur">
                  <input type="color" [value]="colis.couleur" 
                         (change)="updateColisCouleur(getCurrentPageIndex() * colisPerPage + i, $any($event.target).value)">
                </div>
                <button class="delete-btn" (click)="supprimerColis(getCurrentPageIndex() * colisPerPage + i)">
                  <span class="delete-icon">üóëÔ∏è</span>
                </button>
              </div>
            </div>
            
            <div class="card-title">{{ colis.type }}</div>
            <div class="card-subtitle" *ngIf="colis.quantite > 1">
              Quantit√©: {{ colis.quantite }} ¬∑ {{ colis.gerbable ? 'Empilable' : 'Non empilable' }} ¬∑ {{ colis.fragile ? 'Fragile' : 'Standard' }}
            </div>
          </div>
          
          <div class="card-visual">
            <div class="package-3d">üì¶</div>
          </div>
          
          <div class="card-info">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Poids</div>
                <div class="info-value">{{ colis.poids }} kg</div>
              </div>
              <div class="info-item">
                <div class="info-label">Volume</div>
                <div class="info-value">{{ (colis.longueur * colis.largeur * colis.hauteur / 1000000).toFixed(3) }} m¬≥</div>
              </div>
            </div>
            
            <div class="dimensions-visual">
              <div class="dimensions-text">
                {{ colis.longueur }}√ó{{ colis.largeur }}√ó{{ colis.hauteur }} cm
              </div>
              <div class="dimensions-note">Longueur √ó Largeur √ó Hauteur</div>
            </div>
          </div>
          
          <div class="card-recipient" *ngIf="colis.nomDestinataire || colis.adresse || colis.telephone">
            <div class="recipient-header">
              <span class="recipient-icon">üë§</span>
              Destinataire
            </div>
            <div class="recipient-details">
              <div class="recipient-line" *ngIf="colis.nomDestinataire">
                <span class="label">Nom:</span> {{ colis.nomDestinataire }}
              </div>
              <div class="recipient-line" *ngIf="colis.adresse">
                <span class="label">Adresse:</span> {{ colis.adresse }}
              </div>
              <div class="recipient-line" *ngIf="colis.telephone">
                <span class="label">T√©l:</span> {{ colis.telephone }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination moderne -->
      <div class="modern-pagination" *ngIf="getTotalPages() > 1">
        <div class="pagination-info">
          Affichage <span class="highlight">{{ getStartIndex() + 1 }} - {{ getEndIndex() }}</span> 
          sur <span class="highlight">{{ listeColis.length }}</span> colis
        </div>
        
        <div class="pagination-nav">
          <button class="nav-btn" [disabled]="currentPage === 0" (click)="goToFirstPage()">‚èÆÔ∏è</button>
          <button class="nav-btn" [disabled]="currentPage === 0" (click)="prevPage()">‚óÄÔ∏è</button>
          
          <button *ngFor="let page of getVisiblePageNumbers()" 
                  class="nav-btn page-number"
                  [class.active]="page - 1 === currentPage"
                  (click)="goToPage(page - 1)">
            {{ page }}
          </button>
          
          <button class="nav-btn" [disabled]="currentPage >= getTotalPages() - 1" (click)="nextPage()">‚ñ∂Ô∏è</button>
          <button class="nav-btn" [disabled]="currentPage >= getTotalPages() - 1" (click)="goToLastPage()">‚è≠Ô∏è</button>
        </div>
      </div>
      
      <!-- Action rapide vers la visualisation -->
      <div class="quick-viz-action" *ngIf="listeColis.length > 0 && simulationResultats">
        <div class="quick-viz-container">
          <div class="quick-viz-info">
            <span class="viz-icon">üéØ</span>
            <div class="viz-text">
              <h4>Simulation pr√™te !</h4>
              <p>{{ listeColis.length }} colis ‚Ä¢ Conteneur optimal trouv√©</p>
            </div>
          </div>
          <button class="btn-quick-viz" (click)="ouvrirVisualisationComplete()">
            <span class="btn-text">Voir la visualisation</span>
            <span class="btn-arrow">‚Üí</span>
          </button>
        </div>
      </div>
    </div>

    <div class="step-actions" *ngIf="listeColis.length === 0">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <p class="no-colis-message">Ajoutez au moins un colis pour continuer</p>
    </div>
    
    <div class="step-actions" *ngIf="listeColis.length > 0">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
    </div>
  </div>

  <!-- Step 3: Choix de Contenant -->
  <div class="step-content" *ngIf="currentStep === 3">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üß±</div>
        <h2>S√©lection du contenant</h2>
        <div class="selection-mode-toggle">
          <label [class.active]="selectionAutoOptimal">
            <input type="checkbox" [checked]="selectionAutoOptimal" (change)="toggleSelectionMode()">
            S√©lection automatique
          </label>
        </div>
      </div>

      <!-- Message explicatif pour le mode de s√©lection -->
      <div class="selection-mode-explanation">
        <p *ngIf="selectionAutoOptimal">
          Mode <strong>automatique</strong> activ√© : le conteneur le plus optimal sera s√©lectionn√© pour vos colis
        </p>
        <p *ngIf="!selectionAutoOptimal">
          Mode <strong>manuel</strong> activ√© : s√©lectionnez le conteneur de votre choix
        </p>
      </div>

      <!-- Affichage du conteneur optimal -->
      <div *ngIf="selectionAutoOptimal && optimalContainer" class="optimal-container-info">
        <div class="optimal-container-card">
          <div class="optimal-badge">
            <span>Recommand√©</span>
          </div>

          <div class="container-header">
            <strong>{{ optimalContainer.containerType }}</strong>
            <span class="container-category">{{ optimalContainer.containerCategory }}</span>
          </div>

          <div class="container-stats">
            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(optimalContainer.volumeUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Volume: {{ optimalContainer.volumeUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(optimalContainer.weightUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Poids: {{ optimalContainer.weightUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="placement-info">
              <strong>{{ optimalContainer.placedItems }}</strong> / {{ optimalContainer.totalItems }} colis plac√©s
            </div>
          </div>

          <div class="container-dimensions">
            <span>{{ optimalContainer.dimensions.longueur }} √ó {{ optimalContainer.dimensions.largeur }} √ó {{
              optimalContainer.dimensions.hauteur }} mm</span>
            <span>Volume: {{ optimalContainer.volume }} m¬≥</span>
            <span>Capacit√©: {{ optimalContainer.capacitePoids }} kg max</span>
          </div>
        </div>
      </div>

      <!-- Affichage des stats du conteneur s√©lectionn√© manuellement -->
      <div *ngIf="!selectionAutoOptimal && selectedContainerStats" class="selected-container-info">
        <div class="selected-container-card">
          <div class="container-header">
            <strong>{{ selectedContainerStats.containerType }}</strong>
            <span class="container-category">{{ selectedContainerStats.containerCategory }}</span>
          </div>

          <div class="container-stats">
            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(selectedContainerStats.volumeUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Volume: {{ selectedContainerStats.volumeUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>

            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="(selectedContainerStats.weightUtilization * 100) + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Poids: {{ selectedContainerStats.weightUtilization | percent:'1.0-0' }}</span>
              </div>
            </div>
          </div>

          <div class="placement-stats">
            <span class="placement-info">
              <strong>{{ selectedContainerStats.placedItems }}</strong> / {{ selectedContainerStats.totalItems }}
              colis plac√©s
            </span>
            <span class="score-info" [class.good-score]="selectedContainerStats.optimalityScore > 0.7"
              [class.medium-score]="selectedContainerStats.optimalityScore > 0.4 && selectedContainerStats.optimalityScore <= 0.7"
              [class.low-score]="selectedContainerStats.optimalityScore <= 0.4">
              Score d'optimalit√©: {{ selectedContainerStats.optimalityScore | percent:'1.0-0' }}
            </span>
          </div>

          <div class="container-dimensions">
            <span>{{ selectedContainerStats.dimensions.longueur }} √ó {{ selectedContainerStats.dimensions.largeur }} √ó
              {{ selectedContainerStats.dimensions.hauteur }} mm</span>
            <span>Volume: {{ selectedContainerStats.volume }} m¬≥</span>
            <span>Capacit√©: {{ selectedContainerStats.capacitePoids }} kg max</span>
          </div>
        </div>
      </div>

      <!-- Indicateur de chargement pour l'√©valuation du conteneur -->
      <div *ngIf="evaluatingContainer" class="container-loading">
        <div class="loading-spinner"></div>
        <span>√âvaluation du conteneur en cours...</span>
      </div>

      <!-- Liste des conteneurs disponibles -->
      <div class="contenants-grid" [class.dimmed]="selectionAutoOptimal && optimalContainer">
        <div *ngFor="let c of containers" class="conteneur-card" [class.selected]="c._id === selectedContainerId"
          [class.optimal]="optimalContainer && c._id === optimalContainer.containerId"
          (click)="selectContainer(c._id)">
          <img *ngIf="c.images && c.images.length > 0" [src]="'https://logidoo.onrender.com' + c.images[0]"
            [alt]="c.type" width="100">
          <div class="conteneur-title">Type: {{ c.type }}</div>
          <div class="conteneur-dimensions">
            {{ c.dimensions.longueur }} √ó {{ c.dimensions.largeur }} √ó {{ c.dimensions.hauteur }} mm
          </div>
          <div class="conteneur-volume">Volume: {{ c.volume }} m¬≥</div>
          <div class="conteneur-poids">Capacit√©: {{ c.capacitePoids }} kg max</div>
          <span class="conteneur-badge" *ngIf="c.categorie === 'conteneur'">Conteneurs</span>
          <span class="conteneur-badge camion" *ngIf="c.categorie === 'camion'">Camions</span>
          <div *ngIf="optimalContainer && c._id === optimalContainer.containerId" class="optimal-marker">
            <span>Optimal</span>
          </div>
        </div>
      </div>
    </div>

    <!-- R√©sum√© moderne des totaux comme dans le Figma -->
    <div *ngIf="listeColis.length > 0" class="modern-summary-section">
      <div class="summary-cards-horizontal">
        <div class="summary-card-modern total-colis">
          <div class="summary-value">{{ calculerNombreColisTotal() }}</div>
          <div class="summary-label">Total colis</div>
        </div>
        
        <div class="summary-card-modern volume-total">
          <div class="summary-value">{{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥</div>
          <div class="summary-label">Volume total</div>
        </div>
        
        <div class="summary-card-modern poids-total">
          <div class="summary-value">{{ calculerPoidsTotal() | number:'1.2-2' }} kg</div>
          <div class="summary-label">Poids total</div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button (click)="goToStep(4)" class="btn-primary"
        *ngIf="listeColis.length > 0 && (selectedContainerId || selectionAutoOptimal)"
        [disabled]="findingOptimal">
        Continuer vers le calcul
      </button>
    </div>
  </div>

  <!-- √âtape 4: Calcul & Simulation -->
  <div [hidden]="currentStep !== 4" class="step-content">
    <div class="modern-step-4">
      <!-- Header avec titre et description -->
      <div class="step-header">
        <div class="step-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#092B8B" stroke-width="2">
            <path d="M9 12l2 2 4-4"/>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
            <path d="M15 6v6"/>
            <path d="M9 18v-6"/>
          </svg>
        </div>
        <div class="step-title">
          <h2>Calcul et Simulation</h2>
          <p>Calculons la r√©partition optimale de vos colis</p>
        </div>
      </div>

      <!-- Pr√©-simulation: Affichage des donn√©es avec design moderne -->
      <div *ngIf="!simulationResultats && !simulationEnCours" class="pre-simulation-modern">
        
        <!-- En-t√™te moderne -->
        <div class="pre-simulation-header">
          <h3>Pr√™t pour le calcul</h3>
          <p>Voici un r√©sum√© de vos donn√©es avant le calcul d'optimisation</p>
        </div>

        <!-- Cartes KPI modernes -->
        <div class="pre-simulation-kpis">
          <div class="kpi-card-pre primary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerNombreColisTotal() }}</div>
              <div class="kpi-label-pre">Colis √† optimiser</div>
            </div>
          </div>
          
          <div class="kpi-card-pre secondary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.828 14.828a4 4 0 0 1-5.656 0"/>
                <path d="M9 9a3 3 0 1 1 6 0c0 1-1 1-1 1H9s-1 0-1-1z"/>
                <path d="M9 21v-7h6v7"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerVolumeTotal() | number:'1.2-2' }}</div>
              <div class="kpi-label-pre">Volume total (m¬≥)</div>
            </div>
          </div>
          
          <div class="kpi-card-pre tertiary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerPoidsTotal() | number:'1.2-2' }}</div>
              <div class="kpi-label-pre">Poids total (kg)</div>
            </div>
          </div>
        </div>

        <!-- Informations conteneur avec design moderne -->
        <div *ngIf="selectedContainerId" class="selected-container-modern">
          <div class="container-info-card">
            <div class="container-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="7" x2="23" y2="7"/>
              </svg>
            </div>
            <div class="container-details">
              <h4>Conteneur s√©lectionn√©</h4>
              <p>{{ getSelectedContainerInfo() }}</p>
            </div>
          </div>
        </div>

        <!-- Bouton de lancement modernis√© -->
        <div class="launch-simulation-modern">
          <button (click)="lancerSimulation()" class="btn-launch-modern" [disabled]="findingOptimal">
            <div class="btn-icon">
              <svg *ngIf="!findingOptimal" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="10,8 16,12 10,16 10,8"/>
              </svg>
              <div *ngIf="findingOptimal" class="spinner-modern"></div>
            </div>
            <span class="btn-text">{{ findingOptimal ? 'Calcul en cours...' : 'Lancer l\'optimisation' }}</span>
          </button>
        </div>
      </div>

      <!-- Calcul en cours -->
      <div *ngIf="simulationEnCours && !simulationResultats" class="simulation-progress">
        <div class="progress-header">
          <h3>Calcul en cours...</h3>
          <p>Optimisation du placement des colis</p>
        </div>
        <div class="progress-visual">
          <div class="progress-ring">
            <div class="progress-circle"></div>
          </div>
          <div class="progress-steps">
            <div class="progress-step active">
              <div class="step-dot"></div>
              <span>Analyse des colis</span>
            </div>
            <div class="progress-step active">
              <div class="step-dot"></div>
              <span>Calcul optimal</span>
            </div>
            <div class="progress-step">
              <div class="step-dot"></div>
              <span>Finalisation</span>
            </div>
          </div>
        </div>
      </div>

      <!-- R√©sultats de la simulation -->
      <div *ngIf="simulationResultats" class="simulation-results">
        <div class="results-header">
          <div class="success-badge">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"/>
              <circle cx="12" cy="12" r="10"/>
            </svg>
            <span>Calcul termin√© avec succ√®s</span>
          </div>
          <div class="execution-time" *ngIf="previewTime">
            <span>Temps d'ex√©cution: {{ previewTime | number:'1.0-0' }}ms</span>
          </div>
        </div>

        <div class="results-dashboard">
          <!-- KPIs principaux -->
          <div class="kpi-grid">
            <div class="kpi-card efficiency">
              <div class="kpi-header">
                <span class="kpi-icon">üìä</span>
                <span class="kpi-label">Efficacit√©</span>
              </div>
              <div class="kpi-value">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</div>
              <div class="kpi-progress">
                <div class="progress-bar-bg">
                  <div class="progress-bar-fill" [style.width]="(simulationResultats.stats.avgVolumeUtilization * 100) + '%'"></div>
                </div>
              </div>
            </div>

            <div class="kpi-card volume">
              <div class="kpi-header">
                <span class="kpi-icon">üìê</span>
                <span class="kpi-label">Volume utilis√©</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }} m¬≥</div>
              <div class="kpi-subtitle">Sur {{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥ total</div>
            </div>

            <div class="kpi-card placement">
              <div class="kpi-header">
                <span class="kpi-icon">üì¶</span>
                <span class="kpi-label">Colis plac√©s</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.placedCount }}<span class="kpi-total">/{{ calculerNombreColisTotal() }}</span></div>
              <div class="kpi-progress">
                <div class="progress-bar-bg">
                  <div class="progress-bar-fill" [style.width]="((simulationResultats.stats.placedCount / calculerNombreColisTotal()) * 100) + '%'"></div>
                </div>
              </div>
            </div>

            <div class="kpi-card containers">
              <div class="kpi-header">
                <span class="kpi-icon">üöõ</span>
                <span class="kpi-label">Conteneurs</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.containersCount }}</div>
              <div class="kpi-subtitle">Conteneur{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }} utilis√©{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }}</div>
            </div>
          </div>

          <!-- D√©tails additionnels -->
          <div class="additional-stats" *ngIf="simulationResultats.stats.unplacedCount > 0">
            <div class="warning-card">
              <div class="warning-icon">‚ö†Ô∏è</div>
              <div class="warning-content">
                <h4>Attention</h4>
                <p>{{ simulationResultats.stats.unplacedCount }} colis n'ont pas pu √™tre plac√©s. 
                   Consid√©rez utiliser un conteneur plus grand ou diviser en plusieurs envois.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Pr√©c√©dent
      </button>
      <button (click)="ouvrirVisualisationComplete()" class="btn-primary" 
        *ngIf="simulationResultats" [disabled]="!simulationResultats">
        Voir les sch√©mas
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- √âtape 5: Visualisation -->
  <div [hidden]="currentStep !== 5" class="step-content">
    <div class="card">
      <h3>Visualisation Interactive</h3>
      <div *ngIf="simulationResultats" class="visualization-container-modern">
        
        <!-- En-t√™te avec informations sur la visualisation -->
        <div class="visualization-header-modern">
          <div class="viz-intro">
            <h4>‚ú® R√©sultats de la simulation</h4>
            <p>Votre simulation a √©t√© calcul√©e avec succ√®s. Explorez maintenant le placement optimis√© de vos colis en modes 2D et 3D.</p>
          </div>

          <!-- Indicateur de modes disponibles -->
          <div class="viz-modes-info">
            <div class="mode-info">
              <div class="mode-icon">üéØ</div>
              <div class="mode-details">
                <h5>Visualisation 2D/3D</h5>
                <p>Basculez entre vue planaire et tridimensionnelle</p>
              </div>
            </div>
            <div class="mode-info">
              <div class="mode-icon">ÔøΩ</div>
              <div class="mode-details">
                <h5>Outils d'analyse</h5>
                <p>Mesures, rotations, et analyse d√©taill√©e</p>
              </div>
            </div>
          </div>
        </div>

        <!-- R√©sum√© des r√©sultats avec design moderne -->
        <div class="viz-results-summary">
          <div class="summary-cards-viz">
            <div class="viz-card efficiency">
              <div class="viz-card-icon">üìä</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</div>
                <div class="viz-card-label">Efficacit√© moyenne</div>
              </div>
            </div>
            
            <div class="viz-card placement">
              <div class="viz-card-icon">üì¶</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.placedCount }}<span class="total-suffix">/{{ calculerNombreColisTotal() }}</span></div>
                <div class="viz-card-label">Colis plac√©s</div>
              </div>
            </div>
            
            <div class="viz-card containers">
              <div class="viz-card-icon">üöõ</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.containersCount }}</div>
                <div class="viz-card-label">Conteneur{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }}</div>
              </div>
            </div>
            
            <div class="viz-card volume">
              <div class="viz-card-icon">üìê</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }}</div>
                <div class="viz-card-label">Volume (m¬≥)</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions de visualisation avec design moderne -->
        <div class="viz-actions-modern">
          <div class="main-action">
            <button class="btn-viz-launch" (click)="ouvrirVisualisationComplete()">
              <div class="btn-viz-content">
                <div class="btn-viz-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                  </svg>
                </div>
                <div class="btn-viz-text">
                  <span class="btn-title">Ouvrir la visualisation interactive</span>
                  <span class="btn-subtitle">Modes 2D & 3D ‚Ä¢ Outils d'analyse</span>
                </div>
              </div>
            </button>
          </div>

          <!-- Info sur les fonctionnalit√©s -->
          <div class="viz-features-info">
            <div class="feature-item">
              <span class="feature-icon">üéÆ</span>
              <span>Navigation 3D fluide</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üìê</span>
              <span>Vue en plan 2D d√©taill√©e</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üìä</span>
              <span>Mesures et statistiques</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üíæ</span>
              <span>Export images & donn√©es</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button (click)="goToStep(6)" class="btn-primary">
        Acc√©der aux options d'export
      </button>
    </div>
  </div>

  <!-- √âtape 6: Export et Actions -->
  <div [hidden]="currentStep !== 6" class="step-content">
    <div class="card">
      <h3>Export et Actions</h3>
      <div class="export-options">
        <div class="export-section">
          <h4>üìä Actions sur votre simulation</h4>
          <div class="actions-grid">
            <div class="action-card">
              <div class="action-icon">üéØ</div>
              <h5>Visualisation compl√®te</h5>
              <p>Acc√®s √† la visualisation 3D avanc√©e avec tous les outils d'analyse</p>
              <button class="btn-primary" (click)="ouvrirVisualisationComplete()">
                Ouvrir la visualisation
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Export Excel</h5>
              <p>T√©l√©charger les donn√©es de la simulation au format Excel</p>
              <button class="btn-primary" (click)="exportExcel()">
                T√©l√©charger Excel
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Sauvegarder</h5>
              <p>Enregistrer votre simulation pour la retrouver plus tard</p>
              <button class="btn-primary" (click)="sauvegarderSimulation()">
                Sauvegarder simulation
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Nouvelle simulation</h5>
              <p>Recommencer avec de nouveaux colis et param√®tres</p>
              <button class="btn-secondary" (click)="nouvelleSimulation()">
                Nouveau calcul
              </button>
            </div>
          </div>
        </div>

        <div class="export-section" *ngIf="simulationResultats">
          <h4>ÔøΩ R√©sum√© de votre simulation</h4>
          <div class="final-summary">
            <div class="summary-row">
              <span class="summary-label">Nom de la simulation :</span>
              <span class="summary-value">{{ getSimulationName() }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Date :</span>
              <span class="summary-value">{{ dateAujourdhui | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Colis trait√©s :</span>
              <span class="summary-value">{{ calculerNombreColisTotal() }} articles</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Conteneurs utilis√©s :</span>
              <span class="summary-value">{{ simulationResultats.stats.containersCount }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Efficacit√© moyenne :</span>
              <span class="summary-value highlight">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Volume total utilis√© :</span>
              <span class="summary-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }} m¬≥</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button class="btn-primary" (click)="nouvelleSimulation()">
        Nouvelle simulation
      </button>
    </div>
  </div>

</div>