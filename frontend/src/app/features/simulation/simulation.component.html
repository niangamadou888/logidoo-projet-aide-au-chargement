<div class="logidoo-container">
  <!-- Header compact avec logo √† gauche et stepper √† droite -->
  <div class="compact-header">
    <div class="header-left">
      <button class="back-btn" routerLink="/dashboard/user">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
      </button>
      <div class="logo">
        <img src="assets/images/logo-logidoo.png" alt="Logidoo" class="logo-image">
      </div>
    </div>
    
    <!-- Stepper compact √† droite -->
    <div class="compact-stepper">
      <div class="step-item" 
           [class.active]="currentStep === 1" 
           [class.completed]="currentStep > 1" 
           (click)="goToStep(1)">
        <div class="step-circle">1</div>
        <span class="step-text">Colis</span>
      </div>
      
      <div class="step-connector"></div>
      
      <div class="step-item" 
           [class.active]="currentStep === 2" 
           [class.completed]="currentStep > 2" 
           [class.disabled]="listeColis.length === 0"
           (click)="listeColis.length > 0 ? goToStep(2) : null">
        <div class="step-circle">2</div>
        <span class="step-text">Contenant</span>
      </div>
    </div>
  </div>

  <!-- Step 1: Ajout de Colis -->
  <div class="step-content" *ngIf="currentStep === 1">
    <!-- Informations de la simulation -->
    <div class="simulation-info-section">
      <h3 class="section-title">
        <span class="icon">üìù</span> 
        Informations de la simulation
      </h3>
      <div class="simulation-inputs">
        <div class="input-group">
          <label for="simulationName">Nom de la simulation *</label>
          <input 
            type="text" 
            id="simulationName" 
            [(ngModel)]="simulationName"
            placeholder="Ex: Livraison Paris - Septembre 2025"
            class="form-input">
        </div>
        <div class="input-group">
          <label for="simulationDescription">Description</label>
          <input 
            type="text" 
            id="simulationDescription" 
            [(ngModel)]="simulationDescription"
            placeholder="Description courte..."
            class="form-input">
        </div>
      </div>
    </div>

    <!-- Layout en grid : Ajout manuel et Import Excel c√¥te √† c√¥te -->
    <div class="dual-input-grid" *ngIf="showInputForms">
      <!-- Section Ajout Manuel -->
      <div class="manual-section">
        <div class="colis-form-card-compact">
          <div class="form-header-compact">
            <h3><span class="icon">üì¶</span> Ajout manuel</h3>
            <p class="subtitle">Saisissez les informations de votre colis</p>
          </div>

          <form [formGroup]="colisForm" class="ultra-compact-form">
            <!-- Ligne 1: Type, Quantit√©, Fragile, Empilable, Couleur -->
            <div class="form-row-primary">
              <div class="form-group-mini">
                <label>Type</label>
                <input type="text" formControlName="type" placeholder="Carton, Palette..." class="form-control-mini">
              </div>
              <div class="form-group-mini quantity">
                <label>Qt√©</label>
                <input type="number" formControlName="quantite" class="form-control-mini" min="1" value="1">
              </div>
              <label class="checkbox-mini">
                <input type="checkbox" formControlName="fragile" />
                <span class="check-text">Fragile</span>
              </label>
              <label class="checkbox-mini">
                <input type="checkbox" formControlName="gerbable" />
                <span class="check-text">Empilable</span>
              </label>
              <div class="color-mini">
                <label>Couleur</label>
                <input type="color" formControlName="couleur" class="color-input-mini">
              </div>
            </div>

            <!-- Ligne 2: Dimensions -->
            <div class="form-row-secondary">
              <label class="dimensions-label">Dimensions (cm) & Poids (kg)</label>
              <div class="dimensions-inputs">
                <input type="number" formControlName="longueur" placeholder="Longueur" class="dimension-input">
                <span class="separator">√ó</span>
                <input type="number" formControlName="largeur" placeholder="Largeur" class="dimension-input">
                <span class="separator">√ó</span>
                <input type="number" formControlName="hauteur" placeholder="Hauteur" class="dimension-input">
                <span class="separator">|</span>
                <input type="number" step="0.1" formControlName="poids" placeholder="Poids" class="dimension-input weight">
              </div>
            </div>

            <!-- Bouton d'ajout -->
            <button type="button" (click)="ajouterColis()" class="btn-add-compact" [disabled]="!colisForm.valid">
              <span class="plus-icon">+</span>
              Ajouter
            </button>
          </form>

          <!-- Section destinataire repliable (plus discr√®te) -->
          <div class="collapsible-mini" *ngIf="!showDestinataireForm">
            <button type="button" class="toggle-mini" (click)="showDestinataireForm = true">
              + Infos destinataire (optionnel)
            </button>
          </div>
          
          <div class="destinataire-section" *ngIf="showDestinataireForm">
            <div class="destinataire-header">
              <span>Informations destinataire</span>
              <button type="button" class="close-mini" (click)="showDestinataireForm = false">√ó</button>
            </div>
            <div class="destinataire-form">
              <input type="text" formControlName="nomDestinataire" placeholder="Nom" class="form-control-mini">
              <input type="text" formControlName="adresse" placeholder="Adresse compl√®te" class="form-control-mini">
              <input type="tel" formControlName="telephone" placeholder="T√©l√©phone" class="form-control-mini">
            </div>
          </div>
        </div>
      </div>

      <!-- Section Import Excel -->
      <div class="excel-section">
        <div class="import-card-enhanced">
          <div class="form-header-compact">
            <h3><span class="icon">üìä</span> Import Excel</h3>
            <p class="subtitle">Importez plusieurs colis en une fois</p>
          </div>
          
          <div class="import-zone">
            <input type="file" #fileInput accept=".xlsx,.xls" (change)="importerDepuisExcel($event)" class="file-input" id="excel-file" style="display: none;">
            
            <div class="drop-area" 
                 (click)="fileInput.click()"
                 (dragover)="onDragOver($event)" 
                 (dragleave)="onDragLeave($event)" 
                 (drop)="onDrop($event)"
                 [class.dragover]="isDragOver">
              <div class="excel-icon">üìÑ</div>
              <p class="drop-text">Glissez votre fichier Excel ici<br>ou cliquez pour choisir</p>
            </div>
            
            <div class="import-actions">
              <button class="btn-uniform btn-secondary" (click)="telechargerModele()">
                <span class="btn-icon">‚¨áÔ∏è</span>
                T√©l√©charger mod√®le
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions apr√®s ajout de colis (manuel ou import) -->
    <div class="post-add-actions" *ngIf="listeColis.length > 0">
      <div class="secondary-actions">
        <button class="btn-secondary-action" (click)="viderTousLesColis()">
          <span class="btn-icon">üóëÔ∏è</span>
          Vider tout
        </button>
        <button class="btn-secondary-action" (click)="ajouterAutresColis()">
          <span class="btn-icon">‚ûï</span>
          Ajouter un autre colis
        </button>
      </div>
    </div>

    <!-- Liste compacte des colis ajout√©s -->
    <div class="compact-colis-container" *ngIf="listeColis.length > 0">
      <div class="compact-colis-header">
        <h3>
          <span class="package-icon">üì¶</span>
          {{ listeColis.length }} colis
        </h3>
        
        <div class="compact-actions">
          <button class="btn-icon" (click)="viderTousLesColis()" title="Vider tout">
            <span>üóëÔ∏è</span>
          </button>
          <button class="btn-icon" (click)="ajouterAutresColis()" title="Ajouter">
            <span>‚ûï</span>
          </button>
        </div>
      </div>
      
      <!-- Liste compacte des colis avec pagination -->
      <div class="compact-colis-list">
        <!-- En-t√™te avec info pagination -->
        <div class="colis-list-header" *ngIf="listeColis.length > 0">
          <span class="colis-count">{{ listeColis.length }} colis ‚Ä¢ Page {{ currentPage }} sur {{ getTotalPages() }}</span>
          <div class="view-controls">
            <span class="items-per-page">Afficher:</span>
            <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
              <option [value]="5">5</option>
              <option [value]="10">10</option>
              <option [value]="20">20</option>
              <option [value]="50">50</option>
            </select>
          </div>
        </div>

        <!-- Liste pagin√©e -->
        <div *ngFor="let colis of getPaginatedColis(); let i = index" 
             class="compact-colis-item">
          
          <!-- Indicateur de couleur -->
          <div class="color-dot" [style.background]="colis.couleur"></div>
          
          <!-- Infos principales -->
          <div class="colis-main-info">
            <div class="colis-title">{{ colis.type }}</div>
            <div class="colis-dimensions">{{ colis.longueur }}√ó{{ colis.largeur }}√ó{{ colis.hauteur }} cm</div>
          </div>
          
          <!-- Stats -->
          <div class="colis-stats">
            <span class="stat">{{ colis.poids }}kg</span>
            <span class="stat">{{ (colis.longueur * colis.largeur * colis.hauteur / 1000000).toFixed(3) }}m¬≥</span>
            <span class="stat" *ngIf="colis.quantite > 1">√ó{{ colis.quantite }}</span>
          </div>
          
          <!-- Actions -->
          <div class="colis-actions">
            <input type="color" [value]="colis.couleur" 
                   (change)="updateColisCouleur(getActualIndex(i), $any($event.target).value)"
                   class="color-picker-mini">
            <button class="delete-btn-mini" (click)="supprimerColis(getActualIndex(i))">
              <span>√ó</span>
            </button>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-controls" *ngIf="getTotalPages() > 1">
          <button class="page-btn" 
                  [disabled]="currentPage === 1" 
                  (click)="goToPage(currentPage - 1)">
            ‚Äπ Pr√©c√©dent
          </button>
          
          <div class="page-numbers">
            <button *ngFor="let page of getPageNumbers()" 
                    class="page-number" 
                    [class.active]="page === currentPage"
                    [class.ellipsis]="page === -1"
                    [disabled]="page === -1"
                    (click)="page !== -1 ? goToPage(page) : null">
              {{ page === -1 ? '...' : page }}
            </button>
          </div>
          
          <button class="page-btn" 
                  [disabled]="currentPage === getTotalPages()" 
                  (click)="goToPage(currentPage + 1)">
            Suivant ‚Ä∫
          </button>
        </div>
      </div>
    </div>

    <div class="step-actions" *ngIf="listeColis.length === 0 || !simulationName.trim()">
      <p class="no-colis-message" *ngIf="listeColis.length === 0">Ajoutez au moins un colis pour continuer</p>
      <p class="no-colis-message" *ngIf="!simulationName.trim()">Donnez un nom √† votre simulation pour continuer</p>
    </div>
    
    <div class="step-actions" *ngIf="listeColis.length > 0 && simulationName.trim()">
      <!-- Pagination ici -->
      <div class="actions-right">
        <button class="btn-primary" (click)="nextStep()" [disabled]="!canProceedFromStep1()">
          <span class="btn-icon">üß±</span>
          Choix de contenant
        </button>
      </div>
    </div>
  </div>

  <!-- Step 2: Choix de Contenant - Style Figma -->
  <div class="step-content" *ngIf="currentStep === 2">
    <div class="figma-container-selection">
      <!-- Layout principal : conteneurs √† gauche, r√©sultats √† droite -->
      <div class="figma-main-layout">
        
        <!-- Section gauche : Grille des conteneurs -->
        <div class="figma-containers-section">
          <!-- Mode de s√©lection : automatique ou manuel -->
          <div class="selection-mode-toggle">
            <label class="mode-option">
              <input type="radio" name="selectionMode" [value]="true" [(ngModel)]="selectionAutoOptimal">
              <span class="radio-custom"></span>
              <span class="mode-text">
                <strong>Automatique</strong>
                <small>Le conteneur optimal sera s√©lectionn√©</small>
              </span>
            </label>
            <label class="mode-option">
              <input type="radio" name="selectionMode" [value]="false" [(ngModel)]="selectionAutoOptimal">
              <span class="radio-custom"></span>
              <span class="mode-text">
                <strong>Manuel</strong>
                <small>S√©lectionnez le conteneur de votre choix</small>
              </span>
            </label>
          </div>
          
          <!-- Grille des conteneurs style Figma -->
          <div class="figma-containers-grid">
            <div *ngFor="let c of containers; let i = index" 
                 class="figma-container-card" 
                 [class.selected]="c._id === selectedContainerId"
                 [class.recommended]="optimalContainer && c._id === optimalContainer.containerId"
                 [class.dimmed]="selectionAutoOptimal && optimalContainer && c._id !== optimalContainer.containerId"
                 (click)="c._id && selectContainer(c._id)">
              
              <!-- Image du conteneur -->
              <div class="figma-container-image">
                <img *ngIf="c.images && c.images.length > 0" 
                     [src]="'https://logidoo-projet-aide-au-chargement-7.onrender.com' + c.images[0]"
                     [alt]="c.type">
                <div *ngIf="!c.images || c.images.length === 0" class="figma-placeholder-image">
                  <span class="container-icon">üì¶</span>
                </div>
              </div>
              
              <!-- Badge recommand√© -->
              <div *ngIf="optimalContainer && c._id === optimalContainer.containerId" 
                   class="figma-recommended-badge">
                Recommand√©
              </div>
              
              <!-- Informations du conteneur -->
              <div class="figma-container-info">
                <h4 class="figma-container-title">{{ c.type }}</h4>
                <div class="figma-container-category">{{ c.categorie }}</div>
                <div class="figma-container-dimensions">
                  {{ c.dimensions.longueur }} √ó {{ c.dimensions.largeur }} √ó {{ c.dimensions.hauteur }} mm
                </div>
                <div class="figma-container-specs">
                  <span>Volume: {{ c.volume }} m¬≥</span>
                  <span>Max: {{ c.capacitePoids }} kg</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Section droite : R√©sultats de simulation (style Figma) -->
        <div class="figma-results-panel" *ngIf="selectedContainerId || selectedContainerStats || optimalContainer">
          <div class="figma-results-header">
            <h3>R√©sultats de la simulation</h3>
            <div class="figma-results-number">1</div>
          </div>
          
          <!-- Informations du contenant s√©lectionn√© -->
          <div class="figma-container-info">
            <h4>Contenant utilis√©</h4>
            <div class="figma-container-name">{{ getSelectedContainerType() }}</div>
            <div class="figma-container-dims">{{ getSelectedContainerDimensions() }}</div>
            <div class="figma-container-capacity">
              <span>Volume : {{ getSelectedContainerVolume() | number:'1.2-2' }} m¬≥</span>
              <span>Poids max : {{ getSelectedContainerWeight() | number:'1.0-0' }} kg</span>
            </div>
          </div>
          
          <!-- Statistiques d'utilisation -->
          <div class="figma-utilization-stats">
            <h4>Taux d'utilisation</h4>
            
            <div class="figma-stat-item">
              <div class="figma-stat-header">
                <span class="figma-stat-label">Volume utilis√©</span>
                <span class="figma-stat-value">{{ (selectedContainerStats?.volumeUtilization || optimalContainer?.volumeUtilization || 0) | percent:'1.0-0' }}</span>
              </div>
              <div class="figma-stat-details">
                {{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥ / {{ getSelectedContainerVolume() | number:'1.2-2' }} m¬≥
              </div>
            </div>
            
            <div class="figma-stat-item">
              <div class="figma-stat-header">
                <span class="figma-stat-label">Poids utilis√©</span>
                <span class="figma-stat-value">{{ (selectedContainerStats?.weightUtilization || optimalContainer?.weightUtilization || 0) | percent:'1.0-0' }}</span>
              </div>
              <div class="figma-stat-details">
                {{ calculerPoidsTotal() | number:'1.0-0' }} kg / {{ getSelectedContainerWeight() | number:'1.0-0' }} kg
              </div>
            </div>
            
            <div class="figma-stat-item">
              <div class="figma-stat-header">
                <span class="figma-stat-label">Colis plac√©s</span>
                <span class="figma-stat-value">{{ (selectedContainerStats?.placedItems || optimalContainer?.placedItems || 0) }} / {{ calculerNombreColisTotal() }}</span>
              </div>
              <div class="figma-stat-details">
                {{ calculerNombreColisTotal() - (selectedContainerStats?.placedItems || optimalContainer?.placedItems || 0) }} colis non plac√©s
              </div>
            </div>
          </div>
          
          <!-- Barres de progression style Figma -->
          <div class="figma-progress-section">
            <div class="figma-progress-item">
              <div class="figma-progress-header">
                <span class="figma-progress-label">Volume - {{ (selectedContainerStats?.volumeUtilization || optimalContainer?.volumeUtilization || 0) * 100 | number:'1.0-0' }}%</span>
              </div>
              <div class="figma-progress-bar">
                <div class="figma-progress-fill volume" 
                     [style.width]="((selectedContainerStats?.volumeUtilization || optimalContainer?.volumeUtilization || 0) * 100) + '%'"></div>
              </div>
            </div>
            
            <div class="figma-progress-item">
              <div class="figma-progress-header">
                <span class="figma-progress-label">Poids - {{ (selectedContainerStats?.weightUtilization || optimalContainer?.weightUtilization || 0) * 100 | number:'1.0-0' }}%</span>
              </div>
              <div class="figma-progress-bar">
                <div class="figma-progress-fill weight" 
                     [style.width]="((selectedContainerStats?.weightUtilization || optimalContainer?.weightUtilization || 0) * 100) + '%'"></div>
              </div>
            </div>
            
            <!-- Informations sur les colis plac√©s -->
            <div class="figma-placement-info">
              <span class="figma-placement-text">{{ (selectedContainerStats?.placedItems || optimalContainer?.placedItems || 0) }} / {{ calculerNombreColisTotal() }} colis plac√©s</span>
              <div class="figma-placement-dimensions">
                {{ calculerNombreColisTotal() > 0 ? '600 x 2400 x 2600 mm' : '- x - x - mm' }}
              </div>
              <div class="figma-placement-specs">
                Volume : {{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥
                <br>
                Capacit√© : {{ calculerPoidsTotal() | number:'1.2-2' }} kg max
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions en bas -->
    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      
      <!-- Si on n'a pas encore de r√©sultats, proposer de lancer la simulation -->
      <div *ngIf="listeColis.length > 0 && (selectedContainerId || selectionAutoOptimal) && !simulationResultats" class="simulation-required">
        <button class="btn-primary btn-pulse" (click)="nextStep()" [disabled]="findingOptimal">
          <span class="btn-icon">ÔøΩ</span>
          Lancer la simulation
          <small class="btn-subtitle">Calculer l'optimisation</small>
        </button>
      </div>
      
      <!-- Si on a des r√©sultats, proposer validation et visualisation -->
      <div class="action-buttons-group" *ngIf="listeColis.length > 0 && (selectedContainerId || selectionAutoOptimal) && simulationResultats">
        <button class="btn-success" (click)="validerSimulation()" [disabled]="findingOptimal">
          <span class="btn-icon">üíæ</span>
          Valider la simulation
        </button>
        
        <button class="btn-primary" (click)="ouvrirVisualisationComplete()" [disabled]="findingOptimal">
          <span class="btn-icon">üéØ</span>
          Lancer la visualisation
        </button>
      </div>
    </div>
  </div>

  <!-- √âtape 4: Calcul & Simulation -->
  <div [hidden]="currentStep !== 4" class="step-content">
    <div class="modern-step-4">
      <!-- Header avec titre et description -->
      <div class="step-header">
        <div class="step-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#092B8B" stroke-width="2">
            <path d="M9 12l2 2 4-4"/>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
            <path d="M15 6v6"/>
            <path d="M9 18v-6"/>
          </svg>
        </div>
        <div class="step-title">
          <h2>Calcul et Simulation</h2>
          <p>Calculons la r√©partition optimale de vos colis</p>
        </div>
      </div>

      <!-- Pr√©-simulation: Affichage des donn√©es avec design moderne -->
      <div *ngIf="!simulationResultats && !simulationEnCours" class="pre-simulation-modern">
        
        <!-- En-t√™te moderne -->
        <div class="pre-simulation-header">
          <h3>Pr√™t pour le calcul</h3>
          <p>Voici un r√©sum√© de vos donn√©es avant le calcul d'optimisation</p>
        </div>

        <!-- Cartes KPI modernes -->
        <div class="pre-simulation-kpis">
          <div class="kpi-card-pre primary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerNombreColisTotal() }}</div>
              <div class="kpi-label-pre">Colis √† optimiser</div>
            </div>
          </div>
          
          <div class="kpi-card-pre secondary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.828 14.828a4 4 0 0 1-5.656 0"/>
                <path d="M9 9a3 3 0 1 1 6 0c0 1-1 1-1 1H9s-1 0-1-1z"/>
                <path d="M9 21v-7h6v7"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerVolumeTotal() | number:'1.2-2' }}</div>
              <div class="kpi-label-pre">Volume total (m¬≥)</div>
            </div>
          </div>
          
          <div class="kpi-card-pre tertiary">
            <div class="kpi-icon-modern">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div class="kpi-content-pre">
              <div class="kpi-value-pre">{{ calculerPoidsTotal() | number:'1.2-2' }}</div>
              <div class="kpi-label-pre">Poids total (kg)</div>
            </div>
          </div>
        </div>

        <!-- Informations conteneur avec design moderne -->
        <div *ngIf="selectedContainerId" class="selected-container-modern">
          <div class="container-info-card">
            <div class="container-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="7" x2="23" y2="7"/>
              </svg>
            </div>
            <div class="container-details">
              <h4>Conteneur s√©lectionn√©</h4>
              <p>{{ getSelectedContainerInfo() }}</p>
            </div>
          </div>
        </div>

        <!-- Bouton de lancement modernis√© -->
        <div class="launch-simulation-modern">
          <button (click)="lancerSimulation()" class="btn-launch-modern" [disabled]="findingOptimal">
            <div class="btn-icon">
              <svg *ngIf="!findingOptimal" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="10,8 16,12 10,16 10,8"/>
              </svg>
              <div *ngIf="findingOptimal" class="spinner-modern"></div>
            </div>
            <span class="btn-text">{{ findingOptimal ? 'Calcul en cours...' : 'Lancer l\'optimisation' }}</span>
          </button>
        </div>
      </div>

      <!-- Calcul en cours -->
      <div *ngIf="simulationEnCours && !simulationResultats" class="simulation-progress">
        <div class="progress-header">
          <h3>Calcul en cours...</h3>
          <p>Optimisation du placement des colis</p>
        </div>
        <div class="progress-visual">
          <div class="progress-ring">
            <div class="progress-circle"></div>
          </div>
          <div class="progress-steps">
            <div class="progress-step active">
              <div class="step-dot"></div>
              <span>Analyse des colis</span>
            </div>
            <div class="progress-step active">
              <div class="step-dot"></div>
              <span>Calcul optimal</span>
            </div>
            <div class="progress-step">
              <div class="step-dot"></div>
              <span>Finalisation</span>
            </div>
          </div>
        </div>
      </div>

      <!-- R√©sultats de la simulation -->
      <div *ngIf="simulationResultats" class="simulation-results">
        <div class="results-header">
          <div class="success-badge">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"/>
              <circle cx="12" cy="12" r="10"/>
            </svg>
            <span>Calcul termin√© avec succ√®s</span>
          </div>
          <div class="execution-time" *ngIf="previewTime">
            <span>Temps d'ex√©cution: {{ previewTime | number:'1.0-0' }}ms</span>
          </div>
        </div>

        <div class="results-dashboard">
          <!-- KPIs principaux -->
          <div class="kpi-grid">
            <div class="kpi-card efficiency">
              <div class="kpi-header">
                <span class="kpi-icon">üìä</span>
                <span class="kpi-label">Efficacit√©</span>
              </div>
              <div class="kpi-value">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</div>
              <div class="kpi-progress">
                <div class="progress-bar-bg">
                  <div class="progress-bar-fill" [style.width]="(simulationResultats.stats.avgVolumeUtilization * 100) + '%'"></div>
                </div>
              </div>
            </div>

            <div class="kpi-card volume">
              <div class="kpi-header">
                <span class="kpi-icon">üìê</span>
                <span class="kpi-label">Volume utilis√©</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }} m¬≥</div>
              <div class="kpi-subtitle">Sur {{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥ total</div>
            </div>

            <div class="kpi-card placement">
              <div class="kpi-header">
                <span class="kpi-icon">üì¶</span>
                <span class="kpi-label">Colis plac√©s</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.placedCount }}<span class="kpi-total">/{{ calculerNombreColisTotal() }}</span></div>
              <div class="kpi-progress">
                <div class="progress-bar-bg">
                  <div class="progress-bar-fill" [style.width]="((simulationResultats.stats.placedCount / calculerNombreColisTotal()) * 100) + '%'"></div>
                </div>
              </div>
            </div>

            <div class="kpi-card containers">
              <div class="kpi-header">
                <span class="kpi-icon">üöõ</span>
                <span class="kpi-label">Conteneurs</span>
              </div>
              <div class="kpi-value">{{ simulationResultats.stats.containersCount }}</div>
              <div class="kpi-subtitle">Conteneur{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }} utilis√©{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }}</div>
            </div>
          </div>

          <!-- D√©tails additionnels -->
          <div class="additional-stats" *ngIf="simulationResultats.stats.unplacedCount > 0">
            <div class="warning-card">
              <div class="warning-icon">‚ö†Ô∏è</div>
              <div class="warning-content">
                <h4>Attention</h4>
                <p>{{ simulationResultats.stats.unplacedCount }} colis n'ont pas pu √™tre plac√©s. 
                   Consid√©rez utiliser un conteneur plus grand ou diviser en plusieurs envois.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Pr√©c√©dent
      </button>
      <button (click)="ouvrirVisualisationComplete()" class="btn-primary" 
        *ngIf="simulationResultats" [disabled]="!simulationResultats">
        Voir les sch√©mas
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- √âtape 5: Visualisation -->
  <div [hidden]="currentStep !== 5" class="step-content">
    <div class="card">
      <h3>Visualisation Interactive</h3>
      <div *ngIf="simulationResultats" class="visualization-container-modern">
        
        <!-- En-t√™te avec informations sur la visualisation -->
        <div class="visualization-header-modern">
          <div class="viz-intro">
            <h4>‚ú® R√©sultats de la simulation</h4>
            <p>Votre simulation a √©t√© calcul√©e avec succ√®s. Explorez maintenant le placement optimis√© de vos colis en modes 2D et 3D.</p>
          </div>

          <!-- Indicateur de modes disponibles -->
          <div class="viz-modes-info">
            <div class="mode-info">
              <div class="mode-icon">üéØ</div>
              <div class="mode-details">
                <h5>Visualisation 2D/3D</h5>
                <p>Basculez entre vue planaire et tridimensionnelle</p>
              </div>
            </div>
            <div class="mode-info">
              <div class="mode-icon">ÔøΩ</div>
              <div class="mode-details">
                <h5>Outils d'analyse</h5>
                <p>Mesures, rotations, et analyse d√©taill√©e</p>
              </div>
            </div>
          </div>
        </div>

        <!-- R√©sum√© des r√©sultats avec design moderne -->
        <div class="viz-results-summary">
          <div class="summary-cards-viz">
            <div class="viz-card efficiency">
              <div class="viz-card-icon">üìä</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</div>
                <div class="viz-card-label">Efficacit√© moyenne</div>
              </div>
            </div>
            
            <div class="viz-card placement">
              <div class="viz-card-icon">üì¶</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.placedCount }}<span class="total-suffix">/{{ calculerNombreColisTotal() }}</span></div>
                <div class="viz-card-label">Colis plac√©s</div>
              </div>
            </div>
            
            <div class="viz-card containers">
              <div class="viz-card-icon">üöõ</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.containersCount }}</div>
                <div class="viz-card-label">Conteneur{{ simulationResultats.stats.containersCount > 1 ? 's' : '' }}</div>
              </div>
            </div>
            
            <div class="viz-card volume">
              <div class="viz-card-icon">üìê</div>
              <div class="viz-card-content">
                <div class="viz-card-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }}</div>
                <div class="viz-card-label">Volume (m¬≥)</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions de visualisation avec design moderne -->
        <div class="viz-actions-modern">
          <div class="main-action">
            <button class="btn-viz-launch" (click)="ouvrirVisualisationComplete()">
              <div class="btn-viz-content">
                <div class="btn-viz-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                  </svg>
                </div>
                <div class="btn-viz-text">
                  <span class="btn-title">Ouvrir la visualisation interactive</span>
                  <span class="btn-subtitle">Modes 2D & 3D ‚Ä¢ Outils d'analyse</span>
                </div>
              </div>
            </button>
          </div>

          <!-- Info sur les fonctionnalit√©s -->
          <div class="viz-features-info">
            <div class="feature-item">
              <span class="feature-icon">üéÆ</span>
              <span>Navigation 3D fluide</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üìê</span>
              <span>Vue en plan 2D d√©taill√©e</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üìä</span>
              <span>Mesures et statistiques</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üíæ</span>
              <span>Export images & donn√©es</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button (click)="goToStep(6)" class="btn-primary">
        Acc√©der aux options d'export
      </button>
    </div>
  </div>

  <!-- √âtape 6: Export et Actions -->
  <div [hidden]="currentStep !== 6" class="step-content">
    <div class="card">
      <h3>Export et Actions</h3>
      <div class="export-options">
        <div class="export-section">
          <h4>üìä Actions sur votre simulation</h4>
          <div class="actions-grid">
            <div class="action-card">
              <div class="action-icon">üéØ</div>
              <h5>Visualisation compl√®te</h5>
              <p>Acc√®s √† la visualisation 3D avanc√©e avec tous les outils d'analyse</p>
              <button class="btn-primary" (click)="ouvrirVisualisationComplete()">
                Ouvrir la visualisation
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Export Excel</h5>
              <p>T√©l√©charger les donn√©es de la simulation au format Excel</p>
              <button class="btn-primary" (click)="exportExcel()">
                T√©l√©charger Excel
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Sauvegarder</h5>
              <p>Enregistrer votre simulation pour la retrouver plus tard</p>
              <button class="btn-primary" (click)="sauvegarderSimulation()">
                Sauvegarder simulation
              </button>
            </div>
            
            <div class="action-card">
              <div class="action-icon">ÔøΩ</div>
              <h5>Nouvelle simulation</h5>
              <p>Recommencer avec de nouveaux colis et param√®tres</p>
              <button class="btn-secondary" (click)="nouvelleSimulation()">
                Nouveau calcul
              </button>
            </div>
          </div>
        </div>

        <div class="export-section" *ngIf="simulationResultats">
          <h4>ÔøΩ R√©sum√© de votre simulation</h4>
          <div class="final-summary">
            <div class="summary-row">
              <span class="summary-label">Nom de la simulation :</span>
              <span class="summary-value">{{ getSimulationName() }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Date :</span>
              <span class="summary-value">{{ dateAujourdhui | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Colis trait√©s :</span>
              <span class="summary-value">{{ calculerNombreColisTotal() }} articles</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Conteneurs utilis√©s :</span>
              <span class="summary-value">{{ simulationResultats.stats.containersCount }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Efficacit√© moyenne :</span>
              <span class="summary-value highlight">{{ (simulationResultats.stats.avgVolumeUtilization * 100) | number:'1.1-1' }}%</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Volume total utilis√© :</span>
              <span class="summary-value">{{ simulationResultats.stats.totalVolume | number:'1.2-2' }} m¬≥</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Pr√©c√©dent</button>
      <button class="btn-primary" (click)="nouvelleSimulation()">
        Nouvelle simulation
      </button>
    </div>
  </div>

</div>