<div class="logidoo-container">
  <!-- Header -->
  <div class="header">
    <button class="back-btn" routerLink="/dashboard/user">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
    </button>
    <div class="logo-container">
      <div class="logo">
        <span class="logo-text">Logid</span>
        <span class="logo-infinity">‚àû</span>
      </div>
    </div>
  </div>

  <!-- Title -->
  <div class="title-section">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
      <polyline points="9,22 9,12 15,12 15,22" />
    </svg>
    <h1>Aide au Chargement</h1>
  </div>

  <!-- Informations Simulation -->
  <div class="simulation-info">
    <form [formGroup]="simulationForm" class="simulation-form">
      <div class="form-row">
        <div class="form-group">
          <label>Nom de la simulation *</label>
          <input type="text" formControlName="nom" placeholder="Ex: Livraison Paris - Janvier 2025"
            class="form-control">
        </div>
        <div class="form-group">
          <label>Description (optionnel)</label>
          <input type="text" formControlName="description" placeholder="Description de la simulation"
            class="form-control">
        </div>
      </div>
    </form>
  </div>

  <div class="main-content">
    <!-- Formulaire d'ajout de colis -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon add-icon">+</div>
        <h2>Ajouter un colis</h2>
      </div>

      <form [formGroup]="colisForm" class="colis-form">
        <div class="form-group">
          <label>Type de colis *</label>
          <input type="text" formControlName="type" placeholder="Ex: Carton, Palette, Sac ..." class="form-control">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Longueur (cm) *</label>
            <input type="number" formControlName="longueur" class="form-control">
          </div>
          <div class="form-group">
            <label>Largeur (cm) *</label>
            <input type="number" formControlName="largeur" class="form-control">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Hauteur (cm) *</label>
            <input type="number" formControlName="hauteur" class="form-control">
          </div>
          <div class="form-group">
            <label>Poids (kg) *</label>
            <input type="number" step="0.1" formControlName="poids" class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label>Quantit√© *</label>
          <input type="number" formControlName="quantite" class="form-control">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label><input type="checkbox" formControlName="fragile" /> Fragile</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" formControlName="gerbable" /> Empilable (gerbable)</label>
          </div>
          <div class="form-group">
            <label>Couleur</label>
            <input type="color" formControlName="couleur" class="form-control" style="height:40px;padding:0;">
          </div>
        </div>

        <!-- Champs destinataire (optionnels) -->
        <div class="destinataire-section">
          <h4>Informations destinataire (optionnel)</h4>
          <div class="form-group">
            <label>Nom Destinataire</label>
            <input type="text" formControlName="nomDestinataire" class="form-control">
          </div>
          <div class="form-group">
            <label>Adresse</label>
            <input type="text" formControlName="adresse" class="form-control">
          </div>
          <div class="form-group">
            <label>T√©l√©phone</label>
            <input type="tel" formControlName="telephone" class="form-control">
          </div>
        </div>

        <button type="button" (click)="ajouterColis()" class="btn-primary full-width" [disabled]="!colisForm.valid">
          Ajouter le colis
        </button>
      </form>
    </div>

    <!-- Colonne droite: wrapper qui empile le choix conteneur + Import Excel -->
    <div class="right-column">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">üß±</div>
          <h2>S√©lection du contenant</h2>
          <div class="selection-mode-toggle">
            <label [class.active]="selectionAutoOptimal">
              <input type="checkbox" [checked]="selectionAutoOptimal" (change)="toggleSelectionMode()">
              S√©lection automatique
            </label>
          </div>
        </div>

        <!-- Message explicatif pour le mode de s√©lection -->
        <div class="selection-mode-explanation">
          <p *ngIf="selectionAutoOptimal">
            Mode <strong>automatique</strong> activ√© : le conteneur le plus optimal sera s√©lectionn√© pour vos colis
          </p>
          <p *ngIf="!selectionAutoOptimal">
            Mode <strong>manuel</strong> activ√© : s√©lectionnez le conteneur de votre choix
          </p>
        </div>

        <!-- Affichage du conteneur optimal -->
        <div *ngIf="selectionAutoOptimal && optimalContainer" class="optimal-container-info">
          <div class="optimal-container-card">
            <div class="optimal-badge">
              <span>Recommand√©</span>
            </div>

            <div class="container-header">
              <strong>{{ optimalContainer.containerType }}</strong>
              <span class="container-category">{{ optimalContainer.containerCategory }}</span>
            </div>

            <div class="container-stats">
              <div class="stat">
                <div class="progress-bar">
                  <div class="progress" [style.width]="(optimalContainer.volumeUtilization * 100) + '%'"></div>
                </div>
                <div class="stat-label">
                  <span>Volume: {{ optimalContainer.volumeUtilization | percent:'1.0-0' }}</span>
                </div>
              </div>

              <div class="stat">
                <div class="progress-bar">
                  <div class="progress" [style.width]="(optimalContainer.weightUtilization * 100) + '%'"></div>
                </div>
                <div class="stat-label">
                  <span>Poids: {{ optimalContainer.weightUtilization | percent:'1.0-0' }}</span>
                </div>
              </div>

              <div class="placement-info">
                <strong>{{ optimalContainer.placedItems }}</strong> / {{ optimalContainer.totalItems }} colis plac√©s
              </div>
            </div>

            <div class="container-dimensions">
              <span>{{ optimalContainer.dimensions.longueur }} √ó {{ optimalContainer.dimensions.largeur }} √ó {{
                optimalContainer.dimensions.hauteur }} mm</span>
              <span>Volume: {{ optimalContainer.volume }} m¬≥</span>
              <span>Capacit√©: {{ optimalContainer.capacitePoids }} kg max</span>
            </div>
          </div>
        </div>

        <!-- Affichage des stats du conteneur s√©lectionn√© manuellement -->
        <div *ngIf="!selectionAutoOptimal && selectedContainerStats" class="selected-container-info">
          <div class="selected-container-card">
            <div class="container-header">
              <strong>{{ selectedContainerStats.containerType }}</strong>
              <span class="container-category">{{ selectedContainerStats.containerCategory }}</span>
            </div>

            <div class="container-stats">
              <div class="stat">
                <div class="progress-bar">
                  <div class="progress" [style.width]="(selectedContainerStats.volumeUtilization * 100) + '%'"></div>
                </div>
                <div class="stat-label">
                  <span>Volume: {{ selectedContainerStats.volumeUtilization | percent:'1.0-0' }}</span>
                </div>
              </div>

              <div class="stat">
                <div class="progress-bar">
                  <div class="progress" [style.width]="(selectedContainerStats.weightUtilization * 100) + '%'"></div>
                </div>
                <div class="stat-label">
                  <span>Poids: {{ selectedContainerStats.weightUtilization | percent:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="placement-stats">
              <span class="placement-info">
                <strong>{{ selectedContainerStats.placedItems }}</strong> / {{ selectedContainerStats.totalItems }}
                colis plac√©s
              </span>
              <span class="score-info" [class.good-score]="selectedContainerStats.optimalityScore > 0.7"
                [class.medium-score]="selectedContainerStats.optimalityScore > 0.4 && selectedContainerStats.optimalityScore <= 0.7"
                [class.low-score]="selectedContainerStats.optimalityScore <= 0.4">
                Score d'optimalit√©: {{ selectedContainerStats.optimalityScore | percent:'1.0-0' }}
              </span>
            </div>

            <div class="container-dimensions">
              <span>{{ selectedContainerStats.dimensions.longueur }} √ó {{ selectedContainerStats.dimensions.largeur }} √ó
                {{ selectedContainerStats.dimensions.hauteur }} mm</span>
              <span>Volume: {{ selectedContainerStats.volume }} m¬≥</span>
              <span>Capacit√©: {{ selectedContainerStats.capacitePoids }} kg max</span>
            </div>
          </div>
        </div>

        <!-- Indicateur de chargement pour l'√©valuation du conteneur -->
        <div *ngIf="evaluatingContainer" class="container-loading">
          <div class="loading-spinner"></div>
          <span>√âvaluation du conteneur en cours...</span>
        </div>

        <!-- Liste des conteneurs disponibles -->
        <div class="contenants-grid" [class.dimmed]="selectionAutoOptimal && optimalContainer">
          <div *ngFor="let c of containers" class="conteneur-card" [class.selected]="c._id === selectedContainerId"
            [class.optimal]="optimalContainer && c._id === optimalContainer.containerId"
            (click)="selectContainer(c._id)">
            <img *ngIf="c.images && c.images.length > 0" [src]="'https://logidoo-projet-aide-au-chargement-7.onrender.com' + c.images[0]"
              [alt]="c.type" width="100">
            <div class="conteneur-matricule">Matricule: {{ c.matricule || 'Non d√©fini' }}</div>
            <div class="conteneur-title">Type: {{ c.type }}</div>
            <div class="conteneur-dimensions">
              {{ c.dimensions.longueur }} √ó {{ c.dimensions.largeur }} √ó {{ c.dimensions.hauteur }} mm
            </div>
            <div class="conteneur-volume">Volume: {{ c.volume }} m¬≥</div>
            <div class="conteneur-poids">Capacit√©: {{ c.capacitePoids }} kg max</div>
            <span class="conteneur-badge" *ngIf="c.categorie === 'conteneur'">Conteneurs</span>
            <span class="conteneur-badge camion" *ngIf="c.categorie === 'camion'">Camions</span>
            <div *ngIf="optimalContainer && c._id === optimalContainer.containerId" class="optimal-marker">
              <span>Optimal</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Import Excel (r√©duite) -->
      <div class="card compact">
        <div class="card-header">
          <div class="card-icon excel-icon">üìä</div>
          <h2>Import Excel</h2>
        </div>
        <div class="excel-actions">
          <button (click)="telechargerModele()" class="btn-download">üì• T√©l√©charger le mod√®le</button>
          <label class="btn-import" style="margin-top: 0.75rem;">
            üì§ Importer Excel
            <input type="file" (change)="importerDepuisExcel($event)" accept=".xlsx,.xls,.csv" style="display: none;">
          </label>
          <p class="excel-hint">Colonnes support√©es: Type, Dimensions, Poids, Qt√©, Destinataire, Fragile, Gerbable,
            Couleur.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste des colis -->
  <div *ngIf="listeColis.length > 0" class="card colis-list">
    <h3>Colis de la simulation ({{ listeColis.length }})</h3>
    <div class="colis-summary">
      <div class="summary-item">
        <strong>{{ calculerNombreColisTotal() }}</strong>
        <span>Total colis</span>
      </div>
      <div class="summary-item">
        <strong>{{ calculerVolumeTotal() | number:'1.2-2' }} m¬≥</strong>
        <span>Volume total</span>
      </div>
      <div class="summary-item">
        <strong>{{ calculerPoidsTotal() | number:'1.2-2' }} kg</strong>
        <span>Poids total</span>
      </div>
    </div>
    <div class="colis-items">
      <div *ngFor="let colis of pagedColis; let i = index" class="colis-item">
        <div class="colis-info">
          <span class="colis-type">
            <span
              style="display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:middle;"
              [style.background]="colis.couleur || '#999999'"></span>
            {{ colis.type }}
          </span>
          <span class="colis-dimensions">
            {{ colis.longueur }}√ó{{ colis.largeur }}√ó{{ colis.hauteur }}cm - {{ colis.poids }}kg
          </span>
          <span *ngIf="colis.quantite > 1" class="colis-quantity">
            Qt√©: {{ colis.quantite }}
          </span>
          <span *ngIf="colis.fragile" class="colis-flag fragile-flag" style="margin-left:8px;">Fragile</span>
          <span *ngIf="colis.gerbable" class="colis-flag" style="margin-left:8px;">Empilable</span>
          <div *ngIf="colis.nomDestinataire" class="colis-destinataire">
            Destinataire: {{ colis.nomDestinataire }} - {{ colis.adresse }} - {{ colis.telephone }}
          </div>
        </div>
        <div class="colis-edit" style="margin-right: 10px;">
          <label style="font-size:12px;color:#555;margin-right:6px;">Couleur:</label>
          <input type="color" [value]="colis.couleur || '#999999'"
            (input)="updateColisCouleur(i, $any($event.target).value)"
            style="width:36px;height:28px;padding:0;border:none;background:transparent;cursor:pointer;" />
          <button type="button" (click)="randomizeColor(i)" title="Couleur al√©atoire"
            style="margin-left:6px;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc;cursor:pointer;">
            üé≤
          </button>
        </div>
        <div class="colis-flags" style="display:flex;gap:12px;align-items:center;margin-right:10px;">
          <label style="font-size:12px;color:#374151;display:flex;align-items:center;gap:6px;">
            <input type="checkbox" [checked]="!!colis.fragile" (change)="toggleFragile(i)" /> Fragile
          </label>
          <label style="font-size:12px;color:#374151;display:flex;align-items:center;gap:6px;">
            <input type="checkbox" [checked]="colis.gerbable !== false" (change)="toggleGerbable(i)" /> Empilable
          </label>
        </div>
        <button (click)="supprimerColis(i)" class="btn-delete">
          Supprimer
        </button>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="action-buttons">
      <button (click)="lancerSimulation()" class="btn-primary full-width"
        *ngIf="(!simulationResultats && !simulationEnCours) && listeColis.length > 0 && (selectedContainerId || selectionAutoOptimal)"
        [disabled]="findingOptimal">
        {{ findingOptimal
          ? 'Recherche du conteneur optimal...'
          : (selectionAutoOptimal
              ? 'Lancer la simulation (s√©lection auto)'
              : 'Lancer la simulation avec le conteneur s√©lectionn√©')
        }}
      </button>
      <button (click)="validerSimulation()" class="btn-validate full-width"
        *ngIf="simulationResultats || simulationEnCours" [disabled]="!simulationForm.valid || loading">
        {{ loading ? 'Chargement...' : 'Valider la simulation' }}
      </button>
      <button (click)="testVisualization()" class="btn-primary full-width"
        *ngIf="simulationResultats && listeColis.length > 0" style="margin-top: 1rem; background: #10b981;">
        Voir la visualisation
      </button>
    </div>
  </div>
  <!-- Pagination -->
<div class="pagination" *ngIf="totalPages > 1">
  <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">‚óÄ</button>

  <button *ngFor="let page of [].constructor(totalPages); let i = index"
          (click)="goToPage(i + 1)"
          [class.active]="currentPage === i + 1">
    {{ i + 1 }}
  </button>

  <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">‚ñ∂</button>
</div>


  <!-- R√©sultats de la simulation -->
  <div *ngIf="simulationResultats" class="card simulation-results">
    <div class="card-header">
      <div class="card-icon">üìà</div>
      <h2>R√©sultats de la simulation</h2>
      <div class="execution-time" *ngIf="previewTime">
        Temps d'ex√©cution: {{ previewTime | number:'1.0-0' }}ms
      </div>
    </div>

    <div class="results-stats">
      <div class="stats-item">
        <strong>{{ simulationResultats.stats.containersCount }}</strong>
        <span>Contenants utilis√©s</span>
      </div>
      <div class="stats-item">
        <strong>{{ simulationResultats.stats.avgVolumeUtilization | percent:'1.0-2' }}</strong>
        <span>Utilisation volume</span>
      </div>
      <div class="stats-item">
        <strong>{{ simulationResultats.stats.avgWeightUtilization | percent:'1.0-2' }}</strong>
        <span>Utilisation poids</span>
      </div>
      <div class="stats-item" [class.warning]="simulationResultats.unplacedItems.length > 0">
        <strong>{{ simulationResultats.stats.placedCount }} / {{ simulationResultats.stats.placedCount +
          simulationResultats.stats.unplacedCount }}</strong>
        <span>Colis plac√©s</span>
      </div>
    </div>

    <!-- Liste des contenants utilis√©s -->
    <div class="containers-used">
      <h3>Contenants utilis√©s</h3>

      <div class="containers-grid">
        <div *ngFor="let container of simulationResultats.containers" class="container-result-card">
          <div class="container-header">
            <div class="container-matricule">{{ container.matricule || 'Non d√©fini' }}</div>
            <strong>{{ container.type }}</strong>
            <span class="container-category">{{ container.categorie }}</span>
          </div>

          <div class="container-stats">
            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="container.utilization.volume + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Volume: {{ container.utilization.volume | number:'1.0-0' }}%</span>
                <span class="secondary">{{ container.used.volume | number:'1.2-2' }}m¬≥ / {{ container.capacity.volume |
                  number:'1.2-2' }}m¬≥</span>
              </div>
            </div>

            <div class="stat">
              <div class="progress-bar">
                <div class="progress" [style.width]="container.utilization.poids + '%'"></div>
              </div>
              <div class="stat-label">
                <span>Poids: {{ container.utilization.poids | number:'1.0-0' }}%</span>
                <span class="secondary">{{ container.used.poids | number:'1.0-0' }}kg / {{ container.capacity.poids |
                  number:'1.0-0' }}kg</span>
              </div>
            </div>
          </div>

          <div class="container-items">
            <h4>Colis ({{ container.items.length }})</h4>
            <div class="items-list">
              <div *ngFor="let item of container.items" class="item">
                <span class="item-dot" [style.background]="item.couleur || '#999999'"></span>
                <span>{{ item.type }} - {{ item.longueur }}√ó{{ item.largeur }}√ó{{ item.hauteur }}cm</span>
                <span *ngIf="item.fragile" class="item-flag-small">Fragile</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Colis non plac√©s -->
    <div *ngIf="simulationResultats.unplacedItems.length > 0" class="unplaced-items">
      <h3 class="warning-title">‚ö†Ô∏è Colis non plac√©s</h3>
      <p>Les colis suivants n'ont pas pu √™tre plac√©s. Consid√©rez l'utilisation de contenants plus grands ou la division
        en lots.</p>

      <div class="unplaced-list">
        <div *ngFor="let item of simulationResultats.unplacedItems" class="unplaced-item">
          <div class="item-info">
            <span class="item-type">{{ item.type }}</span>
            <span class="item-dimensions">{{ item.longueur }}√ó{{ item.largeur }}√ó{{ item.hauteur }}cm</span>
            <span class="item-weight">{{ item.poids }}kg</span>
            <span *ngIf="item.fragile" class="item-flag">Fragile</span>
            <span *ngIf="!item.gerbable" class="item-flag">Non empilable</span>
          </div>
          <div class="item-error">
            <span class="error-code" [ngSwitch]="item.error">
              <ng-container *ngSwitchCase="'DIMENSIONS_TROP_GRANDES'">Dimensions trop grandes</ng-container>
              <ng-container *ngSwitchCase="'POIDS_DEPASSE'">Poids trop √©lev√©</ng-container>
              <ng-container *ngSwitchCase="'VOLUME_DEPASSE'">Volume trop important</ng-container>
              <ng-container *ngSwitchCase="'COLIS_FRAGILE'">Impossible de placer (fragile)</ng-container>
              <ng-container *ngSwitchCase="'COLIS_NON_GERBABLE'">Impossible d'empiler</ng-container>
              <ng-container *ngSwitchDefault>Placement impossible</ng-container>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add these styles to your component's scss file or styles.scss -->
<!-- <style>

</style> -->
